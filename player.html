<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Player Dashboard - Get in the Game Show</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@keyframes quickFlash {
0% { opacity: 0; transform: scale(0.2); }
35% { opacity: 1; transform: scale(1.1); }
100% { opacity: 0; transform: scale(0.5); }
}
@keyframes buzzer-glow {
0%, 100% { box-shadow: 0 0 30px rgba(255, 193, 7, 0.4); }
50% { box-shadow: 0 0 50px rgba(255, 193, 7, 0.8); }
}
@keyframes buzzer-pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.02); }
}
@keyframes fireworkConfetti {
0% {
transform: translate(0, 0) rotate(0deg) scale(1);
opacity: 1;
}
25% {
transform: translate(var(--dx), var(--dy)) rotate(90deg) scale(0.8);
opacity: 1;
}
50% {
transform: translate(calc(var(--dx) * 1.5), calc(var(--dy) * 1.5)) rotate(180deg) scale(0.6);
opacity: 0.8;
}
100% {
transform: translate(calc(var(--dx) * 2), calc(var(--dy) * 2)) rotate(360deg) scale(0.2);
opacity: 0;
}
}
@keyframes float-up {
0% { transform: translateY(0) scale(1); opacity: 1; }
100% { transform: translateY(-200px) scale(1.5); opacity: 0; }
}
@keyframes glow-pulse {
0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.5); }
50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.8), 0 0 40px rgba(20, 184, 166, 0.4); }
}
@keyframes qr-glow {
0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.3); }
50% { box-shadow: 0 0 25px rgba(255, 255, 255, 0.6), 0 0 35px rgba(255, 193, 7, 0.4); }
}
@keyframes logo-glow {
0%, 100% { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3)); }
50% { filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.6)); }
}
@keyframes reconnecting {
0%, 100% { opacity: 0.5; }
50% { opacity: 1; }
}

.sparkle {
animation: quickFlash 0.25s ease-out;
pointer-events: none;
}
.buzzer-glow {
animation: buzzer-glow 2s ease-in-out infinite, buzzer-pulse 3s ease-in-out infinite;
}
.confetti-piece {
position: absolute;
animation: fireworkConfetti 2.5s ease-out forwards;
z-index: 1000;
width: 6px;
height: 6px;
}
.party-emoji {
position: absolute;
animation: float-up 4s ease-out forwards;
z-index: 100;
}
.celebration-text {
animation: glow-pulse 2s ease-in-out infinite;
}
.qr-box-glow {
animation: qr-glow 3s ease-in-out infinite;
}
.logo-glow {
animation: logo-glow 3s ease-in-out infinite;
}
.reconnecting {
animation: reconnecting 1s ease-in-out infinite;
}

body {
background: linear-gradient(135deg, #1e3a8a 0%, #312e81 50%, #1e1b4b 100%);
margin: 0;
font-family: 'Inter', system-ui, -apple-system, sans-serif;
min-height: 100vh;
overflow-x: hidden;
}

.copyright-footer {
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: rgba(0, 0, 0, 0.8);
color: white;
text-align: center;
padding: 8px;
font-size: 12px;
z-index: 1000;
}

.game-code-input {
font-size: 18px;
line-height: 1.2;
padding: 12px !important;
}

.team-name-input {
font-size: 18px;
line-height: 1.2;
padding: 12px !important;
}

.turquoise-button {
background: linear-gradient(to right, #06b6d4, #0891b2);
}

.turquoise-button:hover {
background: linear-gradient(to right, #0891b2, #0e7490);
}

.reconnecting-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.7);
display: flex;
align-items: center;
justify-content: center;
z-index: 10000;
}
</style>
</head>
<body>

<div id="app" class="relative min-h-screen overflow-hidden">

<!-- Reconnecting Overlay -->
<div id="reconnectingOverlay" class="reconnecting-overlay" style="display: none;">
<div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 text-center">
<div class="text-white text-lg mb-2 reconnecting">üîÑ Reconnecting...</div>
<div class="text-white/70 text-sm">Getting you back in the game!</div>
</div>
</div>

<!-- Sparkles Container -->
<div id="sparkles"></div>

<!-- Entry Screen -->
<div id="entryScreen" class="min-h-screen flex flex-col items-center justify-center p-4">
<div class="mb-8 text-center">
<img
src="logo.png"
alt="Get in the Game Show Logo"
class="logo-glow w-full max-w-md h-32 mx-auto mb-4 object-contain px-4"
onerror="this.style.display='none'"
/>
<div class="text-white text-3xl font-bold mb-2">‚ö° GET EXCITED ‚ö°</div>
</div>

<div class="w-full max-w-sm">
<div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
<div class="text-white text-lg font-medium mb-6 text-center">Ready to Play? ü§©</div>
<div class="space-y-4">
<div>
<input
type="text"
id="gameCodeInput"
class="game-code-input w-full bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 text-center font-bold uppercase tracking-wider"
placeholder="Enter 6-digit code"
maxlength="6"
/>
</div>
<button
id="joinGameBtn"
class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold py-4 px-6 rounded-xl text-xl hover:from-yellow-300 hover:to-orange-400 transform hover:scale-105 transition-all duration-200 shadow-lg"
>
üéüÔ∏è JOIN GAME ü™©
</button>
</div>
</div>
</div>
</div>

<!-- Team Setup Screen -->
<div id="teamSetupScreen" class="min-h-screen flex flex-col items-center justify-center p-4" style="display: none;">
<div class="mb-8 text-center">
<img
src="logo.png"
alt="Get in the Game Show Logo"
class="logo-glow w-full max-w-md h-32 mx-auto mb-4 object-contain px-4"
onerror="this.style.display='none'"
/>
<div class="text-white text-2xl font-bold">‚≠êÔ∏è YAY! Welcome to the Game! ‚≠êÔ∏è</div>
</div>

<div class="w-full max-w-sm">
<div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
<div class="text-white text-lg font-medium mb-6 text-center">Now come up with a Team Name! üí´</div>
<div class="space-y-4">
<div>
<input
type="text"
id="teamNameInput"
class="team-name-input w-full bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 text-center font-bold"
placeholder="ENTER YOUR TEAM NAME"
maxlength="40"
/>
<div class="text-right text-white/60 text-sm mt-2">
<span id="charCount">0</span>/40 characters
</div>
</div>
<button
id="submitTeamBtn"
class="w-full turquoise-button text-white font-bold py-4 px-6 rounded-xl text-xl transform hover:scale-105 transition-all duration-200 shadow-lg"
>
ü•≥ LET'S PLAY! ü•≥
</button>
</div>
</div>
</div>
</div>

<!-- Dashboard Screen -->
<div id="dashboardScreen" class="min-h-screen flex flex-col p-2 pb-16" style="display: none;">
<!-- Header -->
<div class="text-center mb-4">
<img
src="logo.png"
alt="Get in the Game Show Logo"
class="logo-glow w-full max-w-md h-32 mx-auto mb-2 object-contain px-4"
onerror="this.style.display='none'"
/>
<h1 class="text-2xl font-bold text-white">‚ö° TEAM DASHBOARD ‚ö°</h1>
</div>

<!-- Team Info Box -->
<div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-4 mb-4 shadow-2xl">
<div class="text-center">
<div class="text-white text-sm font-bold mb-1">TEAM</div>
<h2 id="teamNameDisplay" class="text-xl font-bold mb-1" style="color: #5de1e6;">‚≠ê Team Name ‚≠ê</h2>
<p class="text-white text-lg mb-3 font-bold">is here to PLAY! ü•≥</p>
<div class="flex space-x-3">
<button
id="cheerBtn"
class="flex-1 text-white border-2 border-purple-300 font-bold py-2 px-1 rounded-lg transition-all transform hover:scale-95 shadow-lg text-base"
style="background-color: #6639ca;"
>
CHEER! üôå
</button>
<button
id="exitGameBtn"
class="flex-1 text-white border-2 font-bold py-2 px-1 rounded-lg shadow-lg text-base transition-all transform hover:scale-95"
style="background-color: #bf0ddd; border-color: #f8acee;"
>
EXIT üé¨
</button>
</div>
</div>
</div>

<!-- QR Code Message Box -->
<div id="qrSection" class="text-center bg-white/10 backdrop-blur-md border border-cyan-400/60 rounded-2xl p-3 mb-4 shadow-lg qr-box-glow">
<div class="text-white text-sm leading-relaxed">
üíé <strong>Scan QR code on the Scoresheet to join our FREQUENT FUN PROGRAM and earn rewards just for playing!</strong> üíé
</div>
</div>

<!-- Giant 3D Buzzer Button -->
<div id="buzzerSection" class="flex-1 flex flex-col items-center justify-center mb-4">
<button
id="buzzerBtn"
class="buzzer-glow w-11/12 aspect-square max-w-sm rounded-full text-center font-bold bg-gradient-to-b from-yellow-400 via-yellow-500 to-yellow-600 text-blue-900 relative shadow-2xl mb-3"
>
<div class="flex flex-col items-center justify-center h-full relative z-10">
<div class="text-lg leading-tight mb-1 font-black">GET READY TO</div>
<div class="text-lg leading-tight mb-3 font-black">GET IN THE GAME!</div>
<div class="text-6xl mb-2">üö®</div>
<div class="text-2xl font-black">TAP TO BUZZ IN!</div>
</div>
<!-- 3D Button Effect Ring -->
<div class="absolute inset-2 rounded-full bg-gradient-to-b from-yellow-300 to-yellow-400 opacity-30"></div>
<div class="absolute inset-4 rounded-full bg-gradient-to-b from-yellow-200 to-yellow-300 opacity-20"></div>
</button>

<!-- Game Code Display -->
<div class="bg-white/10 backdrop-blur-md border border-white/30 rounded-lg px-4 py-2">
<div class="text-white/70 text-xs text-center mb-1">GAME CODE</div>
<div id="gameCodeDisplay" class="text-white font-bold text-lg text-center tracking-wider font-mono">------</div>
</div>
</div>
</div>

<!-- Celebration Screen -->
<div id="celebrationScreen" class="min-h-screen flex flex-col items-center justify-center p-4 pb-16" style="display: none;">
<div id="confettiContainer"></div>
<div class="text-center space-y-6">
<img
src="logo.png"
alt="Get in the Game Show Logo"
class="logo-glow w-full max-w-md h-32 mx-auto object-contain px-4"
onerror="this.style.display='none'"
/>
<div id="placementMessage" class="text-4xl font-bold text-white celebration-text mb-6">
üéâ You got 1st place! üéâ
</div>
<div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 celebration-text">
<div class="text-2xl font-bold text-white mb-4">
You just earned 1000 sMiles! ü§©
</div>
<div class="text-lg text-white mb-4">
Scan QR code on scoresheet to join Frequent Fun Program and earn your first bonus gift! üéÅ
</div>
<button
id="exitCelebrationBtn"
class="w-full text-white border-2 font-bold py-3 px-4 rounded-lg shadow-lg text-base transition-all transform hover:scale-95"
style="background-color: #bf0ddd; border-color: #f8acee;"
>
üé¨ EXIT GAME üé¨
</button>
</div>
</div>
</div>

<!-- Copyright Footer -->
<div class="copyright-footer">
Copyright 2025 Get in the Game Show, LLC. <br>All Rights Reserved<br>
By playing you agree to our <a href="https://thedoctoroffun.com/terms-of-service/" target="_blank" rel="noopener" style="color: #5de1e6; text-decoration: underline;">Terms of Service</a>
</div>
  
<script>
// Enhanced debug logging
const DEBUG = true;
function debugLog(...args) {
  if (DEBUG) {
    console.log('[GITG Debug]', ...args);
  }
}

// Initialize Supabase with retry logic
const supabaseUrl = 'https://tqpuxtswcuwruaqhompl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxcHV4dHN3Y3V3cnVhcWhvbXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NDUyMjQsImV4cCI6MjA3MzEyMTIyNH0.JF71Ap_FJG872iApuXaKW-vNN5TWPiJXvmz6PXWm4cU';

let supabaseClient;
let isSupabaseReady = false;

function initSupabase() {
  try {
    const supabaseUrl = 'https://tqpuxtswcuwruaqhompl.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxcHV4dHN3Y3V3cnVhcWhvbXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NDUyMjQsImV4cCI6MjA3MzEyMTIyNH0.JF71Ap_FJG872iApuXaKW-vNN5TWPiJXvmz6PXWm4cU';
    
    if (!window.supabase) {
      console.error('Supabase library not loaded!');
      return false;
    }
    
    supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
    isSupabaseReady = true;
    console.log('Supabase initialized successfully');
    return true;
  } catch (error) {
    console.error('Error initializing Supabase:', error);
    return false;
  }
}

// Game state
let currentScreen = 'entry';
let gameCode = '';
let teamName = '';
let teamId = null;
let gameId = null;
let isBuzzed = false;
let realtimeChannel = null;
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 3;

// Enhanced multi-layer storage system
const STORAGE_KEY = 'gitg_game_state';
const BACKUP_KEY = 'gitg_backup_state';
const EXPIRY_HOURS = 12; // Extended expiry time

// Multiple storage mechanisms for maximum reliability
function saveGameState() {
  const state = {
    gameCode,
    teamName,
    gameId,
    teamId,
    isBuzzed,
    timestamp: Date.now(),
    url: window.location.href,
    userAgent: navigator.userAgent.substring(0, 100) // Truncated for storage
  };

  debugLog('Saving game state:', state);

  // Strategy 1: sessionStorage (primary)
  try {
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    debugLog('State saved to sessionStorage');
  } catch (e) {
    debugLog('SessionStorage save failed:', e);
  }

  // Strategy 2: localStorage (backup)
  try {
    localStorage.setItem(BACKUP_KEY, JSON.stringify(state));
    debugLog('State saved to localStorage backup');
  } catch (e) {
    debugLog('LocalStorage backup save failed:', e);
  }

  // Strategy 3: In-memory (last resort)
  window.gameStateBackup = state;
  
  // Strategy 4: URL fragment (for some browsers)
  try {
    const encodedState = btoa(JSON.stringify({
      gc: gameCode,
      tn: teamName,
      gi: gameId,
      ti: teamId,
      ts: Date.now()
    }));
    history.replaceState(null, '', `#state=${encodedState}`);
  } catch (e) {
    debugLog('URL fragment save failed:', e);
  }
}

function loadGameState() {
  let state = null;

  // Strategy 1: Try sessionStorage first
  try {
    const stored = sessionStorage.getItem(STORAGE_KEY);
    if (stored) {
      state = JSON.parse(stored);
      debugLog('State loaded from sessionStorage:', state);
    }
  } catch (e) {
    debugLog('SessionStorage load failed:', e);
  }

  // Strategy 2: Try localStorage backup
  if (!state || !state.gameCode) {
    try {
      const stored = localStorage.getItem(BACKUP_KEY);
      if (stored) {
        state = JSON.parse(stored);
        debugLog('State loaded from localStorage backup:', state);
      }
    } catch (e) {
      debugLog('LocalStorage backup load failed:', e);
    }
  }

  // Strategy 3: Try in-memory backup
  if (!state || !state.gameCode) {
    if (window.gameStateBackup && window.gameStateBackup.gameCode) {
      state = window.gameStateBackup;
      debugLog('State loaded from memory backup:', state);
    }
  }

  // Strategy 4: Try URL fragment
  if (!state || !state.gameCode) {
    try {
      const hash = window.location.hash;
      if (hash.includes('state=')) {
        const encodedState = hash.split('state=')[1];
        const decodedState = JSON.parse(atob(encodedState));
        if (decodedState.gc && decodedState.tn) {
          state = {
            gameCode: decodedState.gc,
            teamName: decodedState.tn,
            gameId: decodedState.gi,
            teamId: decodedState.ti,
            timestamp: decodedState.ts || Date.now()
          };
          debugLog('State loaded from URL fragment:', state);
        }
      }
    } catch (e) {
      debugLog('URL fragment load failed:', e);
    }
  }

  if (!state || !state.gameCode) {
    debugLog('No valid game state found');
    return null;
  }

  // Check expiry with extended time
  const EXPIRY = EXPIRY_HOURS * 60 * 60 * 1000;
  if (state.timestamp && (Date.now() - state.timestamp > EXPIRY)) {
    debugLog('Game state expired');
    clearGameState();
    return null;
  }

  debugLog('Valid game state found:', state);
  return state;
}

function clearGameState() {
  debugLog('Clearing all game state');
  
  try {
    sessionStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(BACKUP_KEY);
  } catch (e) {
    debugLog('Error clearing storage:', e);
  }
  
  window.gameStateBackup = null;
  
  // Clear URL fragment
  try {
    history.replaceState(null, '', window.location.pathname);
  } catch (e) {
    debugLog('Error clearing URL fragment:', e);
  }
}

// Audio functions
async function playBuzzerSound() {
  try {
    const audio = new Audio('buzzer.mp3');
    await audio.play();
  } catch (e) {
    debugLog('Buzzer sound failed:', e);
  }
}

function playClappingSound() {
  try {
    new Audio('clapping.mp3').play().catch(() => {});
  } catch (e) {}
}

function playFanfareSound() {
  try {
    new Audio('fanfare.mp3').play().catch(() => {});
  } catch (e) {}
}

// Sparkle effect
function createSparkle() {
  const shapes = ['‚ú¶', '‚Ä¢', '¬∑', '*', '‚úß', '‚ãÜ', '‚ó¶'];
  const sparklesContainer = document.getElementById('sparkles');
  
  for(let i = 0; i < 3; i++) {
    setTimeout(() => {
      const sparkle = document.createElement('div');
      sparkle.className = 'sparkle';
      sparkle.style.position = 'absolute';
      sparkle.style.left = (Math.random() * 90 + 5) + '%';
      sparkle.style.top = (Math.random() * 90 + 5) + '%';
      sparkle.style.color = 'white';
      sparkle.style.fontSize = (Math.random() < 0.4 ? 6 : Math.random() < 0.7 ? 10 : 14) + 'px';
      sparkle.style.textShadow = '0 0 4px rgba(255,255,255,0.8)';
      sparkle.textContent = shapes[Math.floor(Math.random() * shapes.length)];
      sparkle.style.zIndex = '5';
      sparklesContainer.appendChild(sparkle);
      
      setTimeout(() => {
        sparkle.remove();
      }, 250);
    }, i * 50);
  }
}

setInterval(createSparkle, 100);

// Screen management with enhanced logging
function showScreen(screen) {
  debugLog('Showing screen:', screen);
  
  document.getElementById('entryScreen').style.display = 'none';
  document.getElementById('teamSetupScreen').style.display = 'none';
  document.getElementById('dashboardScreen').style.display = 'none';
  document.getElementById('celebrationScreen').style.display = 'none';
  
  if (screen === 'entry') {
    document.getElementById('entryScreen').style.display = 'flex';
  } else if (screen === 'teamSetup') {
    document.getElementById('teamSetupScreen').style.display = 'flex';
  } else if (screen === 'dashboard') {
    document.getElementById('dashboardScreen').style.display = 'flex';
    document.getElementById('gameCodeDisplay').textContent = gameCode || '------';
  } else if (screen === 'celebration') {
    document.getElementById('celebrationScreen').style.display = 'flex';
  }
  
  currentScreen = screen;
}

function showReconnectingOverlay(show = true) {
  document.getElementById('reconnectingOverlay').style.display = show ? 'flex' : 'none';
}

// Enhanced party effects
function createPartyEmojis() {
  const emojis = ['üéâ', 'üéä', 'ü•≥', 'üéà', '‚ú®', 'üåü', 'üí´', 'üï∫'];
  for (let i = 0; i < 15; i++) {
    setTimeout(() => {
      const emoji = document.createElement('div');
      emoji.className = 'party-emoji';
      emoji.style.position = 'absolute';
      emoji.style.left = Math.random() * 100 + '%';
      emoji.style.bottom = '0px';
      emoji.style.fontSize = '20px';
      emoji.style.zIndex = '100';
      emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      document.body.appendChild(emoji);
      setTimeout(() => emoji.remove(), 4000);
    }, i * 150);
  }
}

function createFireworkConfetti() {
  const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7'];
  const container = document.getElementById('confettiContainer');
  const screenWidth = window.innerWidth;
  const screenHeight = window.innerHeight;
  
  const explosionPoints = [
    { x: screenWidth * 0.2, y: screenHeight * 0.3 },
    { x: screenWidth * 0.8, y: screenHeight * 0.3 },
    { x: screenWidth * 0.5, y: screenHeight * 0.2 },
    { x: screenWidth * 0.3, y: screenHeight * 0.5 },
    { x: screenWidth * 0.7, y: screenHeight * 0.5 }
  ];
  
  explosionPoints.forEach((point, explosionIndex) => {
    const piecesCount = 8 + Math.random() * 4;
    for (let i = 0; i < piecesCount; i++) {
      setTimeout(() => {
        const confetti = document.createElement('div');
        confetti.className = 'confetti-piece';
        confetti.style.left = point.x + 'px';
        confetti.style.top = point.y + 'px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        confetti.style.zIndex = '1000';
        
        const angle = (Math.PI * 2 * i) / piecesCount + (Math.random() - 0.5) * 0.5;
        const distance = 100 + Math.random() * 150;
        const dx = Math.cos(angle) * distance;
        const dy = Math.sin(angle) * distance;
        
        confetti.style.setProperty('--dx', dx + 'px');
        confetti.style.setProperty('--dy', dy + 'px');
        
        container.appendChild(confetti);
        setTimeout(() => confetti.remove(), 2500);
      }, i * 20 + explosionIndex * 100);
    }
  });
}

// Enhanced Supabase functions with retry logic
async function withRetry(fn, maxAttempts = 3, delay = 1000) {
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      const result = await fn();
      return result;
    } catch (error) {
      debugLog(`Attempt ${attempt} failed:`, error);
      if (attempt === maxAttempts) throw error;
      await new Promise(resolve => setTimeout(resolve, delay * attempt));
    }
  }
}

async function validateGameCode(code) {
  if (!isSupabaseReady) {
    debugLog('Supabase not ready for game validation');
    return null;
  }

  try {
    const result = await withRetry(async () => {
      const { data, error } = await supabase
        .from('games')
        .select('id, status')
        .eq('game_code', code)
        .single();
      
      if (error) throw error;
      return data;
    });

    if (!result) {
      debugLog('Game validation failed: no data');
      return null;
    }

    if (result.status === 'active' || result.status === 'scores_revealed') {
      debugLog('Game validation successful:', result);
      return result.id;
    }

    debugLog('Game not in valid state:', result.status);
    return null;
  } catch (e) {
    debugLog('Error validating game code:', e);
    return null;
  }
}

async function attemptReconnection() {
  if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
    debugLog('Max reconnection attempts reached');
    return false;
  }

  reconnectAttempts++;
  debugLog(`Reconnection attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}`);

  const savedState = loadGameState();
  if (!savedState) {
    debugLog('No saved state found for reconnection');
    return false;
  }

  if (!isSupabaseReady) {
    debugLog('Supabase not ready for reconnection');
    return false;
  }

  showReconnectingOverlay(true);

  try {
    debugLog('Attempting reconnection with state:', savedState);

    // Validate game still exists and is active with retry
    const validGameId = await withRetry(() => validateGameCode(savedState.gameCode));
    if (!validGameId) {
      debugLog('Game no longer valid during reconnection');
      clearGameState();
      showReconnectingOverlay(false);
      return false;
    }

    // Check if team still exists in game with retry
    const existingTeam = await withRetry(async () => {
      const { data, error } = await supabase
        .from('teams')
        .select('*')
        .eq('game_id', validGameId)
        .eq('name', savedState.teamName)
        .single();
      
      if (error) throw error;
      return data;
    });

    if (!existingTeam) {
      debugLog('Team not found during reconnection');
      clearGameState();
      showReconnectingOverlay(false);
      return false;
    }

    // Restore game state
    gameCode = savedState.gameCode;
    teamName = savedState.teamName;
    gameId = validGameId;
    teamId = existingTeam.id;
    isBuzzed = !!existingTeam.buzzed_at;

    debugLog('Game state restored:', { gameCode, teamName, gameId, teamId, isBuzzed });

    // Update UI
    document.getElementById('teamNameDisplay').innerHTML = `‚≠ê ${teamName} ‚≠ê`;
    document.getElementById('teamNameDisplay').style.color = '#5de1e6';

    // Set buzzer state based on database
    if (isBuzzed) {
      setBuzzerToBuzzedState();
    } else {
      resetBuzzerToReady();
    }

    // Check if game is in scores_revealed state
    const gameData = await withRetry(async () => {
      const { data, error } = await supabase
        .from('games')
        .select('status, scores_data')
        .eq('id', gameId)
        .single();
      
      if (error) throw error;
      return data;
    });

    if (gameData && gameData.status === 'scores_revealed' && gameData.scores_data) {
      try {
        const placements = gameData.scores_data;
        const myPlacement = placements[teamId];
        if (myPlacement) {
          showReconnectingOverlay(false);
          showCelebration(myPlacement);
          setupRealtime();
          reconnectAttempts = 0; // Reset on success
          return true;
        }
      } catch (e) {
        debugLog('Error parsing scores data on reconnect:', e);
      }
    }

    // Setup realtime and show dashboard
    setupRealtime();
    showReconnectingOverlay(false);
    showScreen('dashboard');
    
    debugLog('Reconnection successful');
    reconnectAttempts = 0; // Reset on success
    return true;

  } catch (e) {
    debugLog('Error during reconnection:', e);
    showReconnectingOverlay(false);
    
    // If this wasn't the last attempt, we'll try again later
    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
      debugLog('Will retry reconnection in 2 seconds');
      setTimeout(attemptReconnection, 2000);
      return false;
    } else {
      clearGameState();
      return false;
    }
  }
}

async function joinGame(code, name) {
  if (!isSupabaseReady) {
    alert('Connection not ready. Please wait and try again.');
    return false;
  }

  const validGameId = await validateGameCode(code);
  if (!validGameId) {
    alert('Invalid game code or game not active!');
    return false;
  }

  // Check if team name already exists in this game with retry
  try {
    const existingTeam = await withRetry(async () => {
      const { data } = await supabase
        .from('teams')
        .select('id')
        .eq('game_id', validGameId)
        .eq('name', name)
        .single();
      return data;
    });

    if (existingTeam) {
      alert('Team name already taken in this game!');
      return false;
    }
  } catch (e) {
    // If error is not "not found", it's a real problem
    if (!e.message.includes('No rows')) {
      debugLog('Error checking existing team:', e);
      alert('Connection error. Please try again.');
      return false;
    }
  }

  // Create new team with retry
  try {
    const data = await withRetry(async () => {
      const { data, error } = await supabase
        .from('teams')
        .insert([{
          game_id: validGameId,
          name: name,
          created_at: new Date().toISOString()
        }])
        .select()
        .single();
      
      if (error) throw error;
      return data;
    });

    gameId = validGameId;
    teamId = data.id;
    isBuzzed = false;
    
    debugLog('Team created successfully:', { gameId, teamId, teamName: name });
    saveGameState();
    return true;

  } catch (error) {
    debugLog('Error joining game:', error);
    alert('Error joining game. Please try again.');
    return false;
  }
}

async function buzzIn() {
  if (!teamId || isBuzzed || !isSupabaseReady) {
    debugLog('Buzz in blocked:', { teamId, isBuzzed, isSupabaseReady });
    return false;
  }

  // INSTANT visual and audio feedback
  isBuzzed = true;
  playBuzzerSound();
  setBuzzerToBuzzedState();
  saveGameState();

  // Add vibration
  if ('vibrate' in navigator) {
    navigator.vibrate([100, 50, 100]);
  }

  // Then update database with retry
  try {
    await withRetry(async () => {
      const { error } = await supabase
        .from('teams')
        .update({
          buzzed_at: new Date().toISOString()
        })
        .eq('id', teamId);
      
      if (error) throw error;
    });

    debugLog('Buzz in successful');
    return true;

  } catch (error) {
    debugLog('Error buzzing in:', error);
    // Revert on error
    isBuzzed = false;
    resetBuzzerToReady();
    saveGameState();
    return false;
  }
}

function setBuzzerToBuzzedState() {
  const buzzer = document.getElementById('buzzerBtn');
  buzzer.className = 'w-11/12 aspect-square max-w-sm rounded-full text-center font-bold bg-gradient-to-b from-green-400 via-green-500 to-green-600 text-white relative shadow-2xl mb-3';
  buzzer.innerHTML = `
    <div class="flex flex-col items-center justify-center h-full relative z-10">
      <div class="text-2xl mb-2 font-black">üî• YOU'RE IN! üî•</div>
      <div class="text-4xl mb-2 animate-pulse">‚ö°</div>
      <div class="text-lg leading-tight mb-1 font-bold">WAIT FOR HOST</div>
      <div class="text-lg leading-tight font-bold">TO CALL ON YOU</div>
    </div>
    <div class="absolute inset-2 rounded-full bg-gradient-to-b from-green-300 to-green-400 opacity-30"></div>
    <div class="absolute inset-4 rounded-full bg-gradient-to-b from-green-200 to-green-300 opacity-20"></div>
  `;
}

function resetBuzzerToReady() {
  const buzzer = document.getElementById('buzzerBtn');
  buzzer.className = 'buzzer-glow w-11/12 aspect-square max-w-sm rounded-full text-center font-bold bg-gradient-to-b from-yellow-400 via-yellow-500 to-yellow-600 text-blue-900 relative shadow-2xl mb-3';
  buzzer.innerHTML = `
    <div class="flex flex-col items-center justify-center h-full relative z-10">
      <div class="text-lg leading-tight mb-1 font-black">GET READY TO</div>
      <div class="text-lg leading-tight mb-3 font-black">GET IN THE GAME!</div>
      <div class="text-6xl mb-2">üö®</div>
      <div class="text-2xl font-black">TAP TO BUZZ!</div>
    </div>
    <div class="absolute inset-2 rounded-full bg-gradient-to-b from-yellow-300 to-yellow-400 opacity-30"></div>
    <div class="absolute inset-4 rounded-full bg-gradient-to-b from-yellow-200 to-yellow-300 opacity-20"></div>
  `;
}

// Enhanced real-time subscriptions with better error handling
function setupRealtime() {
  if (realtimeChannel) {
    supabase.removeChannel(realtimeChannel);
  }

  if (!isSupabaseReady || !teamId || !gameId) {
    debugLog('Cannot setup realtime - missing requirements:', { isSupabaseReady, teamId, gameId });
    return;
  }

  debugLog('Setting up realtime for team:', teamId, 'game:', gameId);

  const channelName = `player_${teamId}_${Date.now()}`;
  realtimeChannel = supabase
    .channel(channelName)
    .on('postgres_changes',
      { event: 'UPDATE', schema: 'public', table: 'teams', filter: `id=eq.${teamId}` },
      (payload) => {
        debugLog('Team update received:', payload);
        const newData = payload.new;
        
        // Handle buzzer clear
        if (!newData.buzzed_at && isBuzzed) {
          debugLog('Buzzer cleared by host');
          isBuzzed = false;
          resetBuzzerToReady();
          saveGameState();
        }
      }
    )
    .on('postgres_changes',
      { event: 'DELETE', schema: 'public', table: 'teams', filter: `id=eq.${teamId}` },
      (payload) => {
        debugLog('Team deleted:', payload);
        alert('You have been removed from the game by the Host.');
        exitGame();
      }
    )
    .on('postgres_changes',
      { event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${gameId}` },
      (payload) => {
        debugLog('Game update received:', payload);
        const newData = payload.new;
        
        // Handle score reveal
        if (newData.status === 'scores_revealed' && newData.scores_data) {
          debugLog('Scores revealed! Data:', newData.scores_data);
          try {
            const placements = newData.scores_data;
            debugLog('Parsed placements:', placements);
            const myPlacement = placements[teamId];
            debugLog('My placement:', myPlacement, 'Team ID:', teamId);
            
            if (myPlacement) {
              showCelebration(myPlacement);
            } else {
              debugLog('No placement found for team ID:', teamId);
            }
          } catch (e) {
            debugLog('Error parsing scores data:', e);
          }
        }
        
        // Handle game end
        if (newData.status === 'ended') {
          alert('Game has ended by the Host.');
          exitGame();
        }
      }
    )
    .subscribe((status) => {
      debugLog('Realtime subscription status:', status);
      
      // Handle connection issues
      if (status === 'SUBSCRIPTION_ERROR' || status === 'CLOSED') {
        debugLog('Realtime connection issue, attempting to reconnect...');
        setTimeout(() => {
          if (teamId && gameId) {
            setupRealtime();
          }
        }, 5000);
      }
    });
}

function showCelebration(placement) {
  debugLog('Showing celebration for placement:', placement);
  const { place, isTie } = placement;

  let message;
  if (isTie) {
    message = `It's a Tie! You Got ${getOrdinal(place)} Place!`;
  } else {
    message = `You got ${getOrdinal(place)} place!`;
  }

  document.getElementById('placementMessage').textContent = `üéâ ${message} üéâ`;

  // Play fanfare and create effects
  playFanfareSound();
  createFireworkConfetti();
  createPartyEmojis();

  // Show celebration screen
  showScreen('celebration');

  // Continue confetti loop
  const confettiInterval = setInterval(() => {
    createFireworkConfetti();
  }, 3000);

  // Clean up after a while
  setTimeout(() => {
    clearInterval(confettiInterval);
  }, 30000);
}

function getOrdinal(num) {
  const suffixes = ['th', 'st', 'nd', 'rd'];
  const v = num % 100;
  return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
}

function exitGame() {
  debugLog('Exiting game');
  
  // Cleanup
  if (realtimeChannel) {
    supabase.removeChannel(realtimeChannel);
  }

  clearGameState();
  gameCode = '';
  teamName = '';
  teamId = null;
  gameId = null;
  isBuzzed = false;
  reconnectAttempts = 0;

  // Reset forms
  document.getElementById('gameCodeInput').value = '';
  document.getElementById('teamNameInput').value = '';
  document.getElementById('charCount').textContent = '0';

  showScreen('entry');
}

// Game code validation
function isValidGameCodeFormat(code) {
  return /^\d{6}$/.test(code);
}

// Enhanced connection monitoring
function monitorConnection() {
  // Check if we're online
  if (!navigator.onLine) {
    debugLog('Device appears to be offline');
    return;
  }

  // If we have a team but no realtime channel, try to reconnect
  if (teamId && gameId && isSupabaseReady && !realtimeChannel) {
    debugLog('Detected missing realtime connection, attempting to restore...');
    setupRealtime();
  }
}

// Run connection monitoring every 30 seconds
setInterval(monitorConnection, 30000);

// Event listeners
document.getElementById('gameCodeInput').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, '').slice(0, 6);
  e.target.value = value;
  gameCode = value;
});

document.getElementById('joinGameBtn').addEventListener('click', async function() {
  if (gameCode.length === 6 && isValidGameCodeFormat(gameCode)) {
    const validGameId = await validateGameCode(gameCode);
    if (validGameId) {
      showScreen('teamSetup');
    } else {
      alert('Invalid game code or game not active!');
    }
  } else if (gameCode.length > 0) {
    alert('Please enter a valid 6-digit game code!');
  } else {
    alert('Please enter a game code!');
  }
});

document.getElementById('teamNameInput').addEventListener('input', function(e) {
  const value = e.target.value.slice(0, 40);
  e.target.value = value;
  teamName = value;
  document.getElementById('charCount').textContent = value.length;
});

document.getElementById('submitTeamBtn').addEventListener('click', async function() {
  if (teamName.trim().length >= 2) {
    const success = await joinGame(gameCode, teamName.trim());
    if (success) {
      document.getElementById('teamNameDisplay').innerHTML = `‚≠ê ${teamName} ‚≠ê`;
      document.getElementById('teamNameDisplay').style.color = '#5de1e6';
      setupRealtime();
      showScreen('dashboard');
    }
  } else {
    alert('Please enter a team name with at least 2 characters!');
  }
});

document.getElementById('buzzerBtn').addEventListener('click', async function() {
  if (!isBuzzed) {
    await buzzIn();
  }
});

document.getElementById('cheerBtn').addEventListener('click', function() {
  playClappingSound();
  createPartyEmojis();
});

document.getElementById('exitGameBtn').addEventListener('click', function() {
  if (confirm('Are you sure you want to leave the game?')) {
    exitGame();
  }
});

document.getElementById('exitCelebrationBtn').addEventListener('click', function() {
  if (confirm('Are you sure you want to leave the game?')) {
    exitGame();
  }
});

// Keyboard support for accessibility
document.addEventListener('keydown', function(e) {
  if (currentScreen === 'dashboard' && (e.key === ' ' || e.key === 'Enter')) {
    e.preventDefault();
    document.getElementById('buzzerBtn').click();
  }
});

// Prevent zoom on double tap for mobile
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
  const now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, false);

// Enhanced page visibility handling
document.addEventListener('visibilitychange', function() {
  if (!document.hidden && teamId && isSupabaseReady) {
    debugLog('Page became visible, syncing state...');
    
    // Page became visible again, check if we need to sync state
    setTimeout(async () => {
      try {
        const teamData = await withRetry(async () => {
          const { data, error } = await supabase
            .from('teams')
            .select('buzzed_at')
            .eq('id', teamId)
            .single();
          
          if (error) throw error;
          return data;
        });

        if (teamData) {
          const dbBuzzed = !!teamData.buzzed_at;
          if (dbBuzzed !== isBuzzed) {
            debugLog('Syncing buzzer state:', { was: isBuzzed, now: dbBuzzed });
            isBuzzed = dbBuzzed;
            if (isBuzzed) {
              setBuzzerToBuzzedState();
            } else {
              resetBuzzerToReady();
            }
            saveGameState();
          }
        }

        // Also check game status
        const gameData = await withRetry(async () => {
          const { data, error } = await supabase
            .from('games')
            .select('status, scores_data')
            .eq('id', gameId)
            .single();
          
          if (error) throw error;
          return data;
        });

        if (gameData && gameData.status === 'scores_revealed' && gameData.scores_data) {
          try {
            const placements = gameData.scores_data;
            const myPlacement = placements[teamId];
            if (myPlacement && currentScreen !== 'celebration') {
              showCelebration(myPlacement);
            }
          } catch (e) {
            debugLog('Error parsing scores data on visibility change:', e);
          }
        }

      } catch (e) {
        debugLog('Error syncing state on visibility change:', e);
      }
    }, 1000); // Increased delay to ensure stability
  }
});

// Enhanced network event handling
window.addEventListener('online', function() {
  debugLog('Connection restored');
  if (teamId && gameId) {
    // Try to sync state when connection is restored
    setTimeout(attemptReconnection, 1000);
  }
});

window.addEventListener('offline', function() {
  debugLog('Connection lost');
});

// Enhanced app initialization with better timing
async function initializeApp() {
  debugLog('Initializing app...');
  
  // Wait for DOM to be fully loaded
  if (document.readyState !== 'complete') {
    await new Promise(resolve => {
      window.addEventListener('load', resolve);
    });
  }
  
  // Initialize Supabase
  initSupabase();
  
  // Wait a bit for Supabase to be ready
  let attempts = 0;
  while (!isSupabaseReady && attempts < 10) {
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  
  if (!isSupabaseReady) {
    debugLog('Supabase initialization failed, showing entry screen');
    showScreen('entry');
    return;
  }
  
  debugLog('Supabase ready, attempting reconnection...');
  const reconnected = await attemptReconnection();
  
  if (!reconnected) {
    debugLog('No reconnection possible, showing entry screen');
    showScreen('entry');
  }
}

// Start the app
initializeApp();
</script>

</body>
</html>
