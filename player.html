<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buzz Game - Player</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f39c12;
            animation: confetti-fall 3s linear infinite;
        }
        .confetti:nth-child(2n) { background: #e74c3c; animation-delay: 0.5s; }
        .confetti:nth-child(3n) { background: #3498db; animation-delay: 1s; }
        .confetti:nth-child(4n) { background: #2ecc71; animation-delay: 1.5s; }
        .confetti:nth-child(5n) { background: #9b59b6; animation-delay: 2s; }
        
        @keyframes buzz-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .buzz-button {
            animation: buzz-pulse 2s ease-in-out infinite;
        }
        
        .buzz-button:active {
            transform: scale(0.95);
        }
        
        @keyframes cheer-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .cheer-animation {
            animation: cheer-bounce 0.6s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white">
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50" style="display: none;"></div>
    
    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- Header -->
        <div class="text-center mb-8">
            <img src="./public/logo.png" alt="Buzz Game Logo" class="mx-auto mb-4 w-32 h-32 object-contain">
            <h1 class="text-4xl font-bold text-yellow-400 mb-2">üéØ BUZZ GAME üéØ</h1>
        </div>

        <!-- Game Join Screen -->
        <div id="join-screen" class="space-y-6">
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
                <h2 class="text-2xl font-bold text-center mb-6 text-yellow-400">Join the Game!</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Game Code</label>
                        <input type="text" id="game-code" 
                               class="w-full p-4 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 text-center text-2xl font-bold uppercase tracking-wider"
                               placeholder="Enter 6-digit code" maxlength="6">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Team Name</label>
                        <input type="text" id="team-name" 
                               class="w-full p-4 bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 text-center text-lg"
                               placeholder="Enter your team name" maxlength="40">
                    </div>
                    
                    <button id="join-btn" 
                            class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold py-4 px-6 rounded-xl text-xl hover:from-yellow-300 hover:to-orange-400 transform hover:scale-105 transition-all duration-200 shadow-lg">
                        JOIN GAME üöÄ
                    </button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" style="display: none;" class="space-y-6">
            <!-- Team Info -->
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/20 text-center">
                <h3 class="text-lg font-medium text-yellow-400 mb-1">Team</h3>
                <p id="current-team-name" class="text-2xl font-bold"></p>
                <p class="text-sm text-white/80 mt-2">are here to PLAY ü•≥</p>
            </div>

            <!-- Buzzer Button -->
            <div id="buzzer-section" class="text-center">
                <button id="buzz-btn" 
                        class="buzz-button w-64 h-64 bg-gradient-to-br from-yellow-400 via-yellow-500 to-orange-500 rounded-full text-black font-black text-4xl shadow-2xl border-8 border-yellow-300 hover:shadow-yellow-400/50 transition-all duration-300 mx-auto block mb-6">
                    üîî<br>BUZZ IN!
                </button>
                
                <div class="space-y-4">
                    <!-- Cheer Button -->
                    <button id="cheer-btn" 
                            class="bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold py-3 px-8 rounded-xl text-lg hover:from-pink-400 hover:to-rose-400 transform hover:scale-105 transition-all duration-200 shadow-lg">
                        CHEER! üéâ
                    </button>
                    
                    <!-- Leave Game Button -->
                    <button id="leave-btn" 
                            class="bg-white/10 text-white font-medium py-2 px-6 rounded-lg text-sm border-2 border-pink-300 hover:bg-white/20 transition-all duration-200">
                        LEAVE GAME
                    </button>
                </div>
            </div>

            <!-- Celebration Screen -->
            <div id="celebration-section" style="display: none;" class="text-center space-y-6">
                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-black rounded-2xl p-6 shadow-2xl">
                    <div id="place-message" class="text-3xl font-bold mb-4"></div>
                    
                    <div class="bg-white/20 rounded-xl p-4 mt-4">
                        <p class="text-xl font-bold mb-2">You just earned 1000 sMiles! ü§©</p>
                        <p class="text-lg">Scan QR code on scoresheet to join Frequent Fun Program and earn your first gift instantly! üéÅ</p>
                    </div>
                </div>
                
                <button id="final-leave-btn" 
                        class="bg-white/10 text-white font-medium py-2 px-6 rounded-lg text-sm border-2 border-pink-300 hover:bg-white/20 transition-all duration-200">
                    LEAVE GAME
                </button>
            </div>

            <!-- Status Display -->
            <div id="status-display" class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20 text-center">
                <p id="status-text" class="text-lg font-medium">Waiting for host to start...</p>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://tqpuxtswcuwruaqhompl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxcHV4dHN3Y3V3cnVhcWhvbXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEzOTU5ODEsImV4cCI6MjA0Njk3MTk4MX0.YHg6Y-6FiAfCGpFSvfRYdEe8Pt9gzHF5WTqN7wGIv5o';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let gameState = {
            gameId: null,
            teamId: null,
            teamName: '',
            gameCode: '',
            hasBuzzed: false,
            scoresRevealed: false
        };

        // Audio elements
        const buzzerSound = new Audio('./public/buzzer.mp3');
        const fanfareSound = new Audio('./public/fanfare.mp3');
        const cheerSound = new Audio('./public/clapping.mp3');

        // DOM elements
        const joinScreen = document.getElementById('join-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameCodeInput = document.getElementById('game-code');
        const teamNameInput = document.getElementById('team-name');
        const joinBtn = document.getElementById('join-btn');
        const buzzBtn = document.getElementById('buzz-btn');
        const cheerBtn = document.getElementById('cheer-btn');
        const leaveBtn = document.getElementById('leave-btn');
        const finalLeaveBtn = document.getElementById('final-leave-btn');
        const currentTeamName = document.getElementById('current-team-name');
        const statusText = document.getElementById('status-text');
        const buzzerSection = document.getElementById('buzzer-section');
        const celebrationSection = document.getElementById('celebration-section');
        const placeMessage = document.getElementById('place-message');
        const confettiContainer = document.getElementById('confetti-container');

        // Check for stored game state on load
        window.addEventListener('load', checkStoredGame);

        function checkStoredGame() {
            const stored = localStorage.getItem('buzzGameState');
            if (stored) {
                const data = JSON.parse(stored);
                // Check if stored data is less than 24 hours old
                if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                    gameState = { ...gameState, ...data };
                    attemptRejoin();
                } else {
                    localStorage.removeItem('buzzGameState');
                }
            }
        }

        async function attemptRejoin() {
            try {
                // Check if game still exists
                const { data: game, error: gameError } = await supabase
                    .from('games')
                    .select('id')
                    .eq('game_code', gameState.gameCode)
                    .eq('status', 'active')
                    .single();

                if (gameError || !game) {
                    localStorage.removeItem('buzzGameState');
                    return;
                }

                // Check if team still exists
                const { data: team, error: teamError } = await supabase
                    .from('teams')
                    .select('id, name, buzzed_at')
                    .eq('game_id', game.id)
                    .eq('name', gameState.teamName)
                    .single();

                if (teamError || !team) {
                    localStorage.removeItem('buzzGameState');
                    return;
                }

                // Successfully rejoined
                gameState.gameId = game.id;
                gameState.teamId = team.id;
                gameState.hasBuzzed = !!team.buzzed_at;
                
                showGameScreen();
                updateBuzzerState();
                subscribeToGameUpdates();
                
                statusText.textContent = 'Reconnected successfully!';
                setTimeout(() => {
                    statusText.textContent = gameState.hasBuzzed ? 'Buzzed in! Wait for host...' : 'Ready to buzz in!';
                }, 2000);
                
            } catch (error) {
                console.error('Rejoin failed:', error);
                localStorage.removeItem('buzzGameState');
            }
        }

        function saveGameState() {
            const stateToSave = {
                ...gameState,
                timestamp: Date.now()
            };
            localStorage.setItem('buzzGameState', JSON.stringify(stateToSave));
        }

        joinBtn.addEventListener('click', joinGame);
        buzzBtn.addEventListener('click', buzzIn);
        cheerBtn.addEventListener('click', playCheer);
        leaveBtn.addEventListener('click', leaveGame);
        finalLeaveBtn.addEventListener('click', leaveGame);

        // Enter key support
        gameCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') teamNameInput.focus();
        });
        teamNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinGame();
        });

        async function joinGame() {
            const code = gameCodeInput.value.trim().toUpperCase();
            const name = teamNameInput.value.trim();

            if (!code || code.length !== 6) {
                alert('Please enter a valid 6-digit game code');
                return;
            }
            if (!name || name.length < 2) {
                alert('Please enter a team name (at least 2 characters)');
                return;
            }

            joinBtn.textContent = 'JOINING...';
            joinBtn.disabled = true;

            try {
                // Find game by code
                const { data: game, error: gameError } = await supabase
                    .from('games')
                    .select('id')
                    .eq('game_code', code)
                    .eq('status', 'active')
                    .single();

                if (gameError || !game) {
                    throw new Error('Game not found or inactive');
                }

                // Check if team name already exists
                const { data: existingTeam, error: checkError } = await supabase
                    .from('teams')
                    .select('id')
                    .eq('game_id', game.id)
                    .eq('name', name)
                    .single();

                if (existingTeam) {
                    throw new Error('Team name already taken');
                }

                // Create team
                const { data: team, error: teamError } = await supabase
                    .from('teams')
                    .insert([{ game_id: game.id, name: name }])
                    .select()
                    .single();

                if (teamError) {
                    throw new Error('Failed to join game');
                }

                // Update game state
                gameState.gameId = game.id;
                gameState.teamId = team.id;
                gameState.teamName = name;
                gameState.gameCode = code;
                gameState.hasBuzzed = false;
                gameState.scoresRevealed = false;

                saveGameState();
                showGameScreen();
                subscribeToGameUpdates();
                
            } catch (error) {
                alert(error.message);
            } finally {
                joinBtn.textContent = 'JOIN GAME üöÄ';
                joinBtn.disabled = false;
            }
        }

        function showGameScreen() {
            joinScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            currentTeamName.textContent = gameState.teamName;
            statusText.textContent = 'Ready to buzz in!';
        }

        async function buzzIn() {
            if (gameState.hasBuzzed) return;

            try {
                buzzerSound.play().catch(() => {}); // Play sound, ignore errors
                
                // Update buzzer state immediately for responsiveness
                gameState.hasBuzzed = true;
                updateBuzzerState();
                
                // Update database
                const { error } = await supabase
                    .from('teams')
                    .update({ buzzed_at: new Date().toISOString() })
                    .eq('id', gameState.teamId);

                if (error) {
                    // Revert state if database update failed
                    gameState.hasBuzzed = false;
                    updateBuzzerState();
                    console.error('Buzz failed:', error);
                } else {
                    statusText.textContent = 'Buzzed in! Wait for host...';
                    saveGameState();
                }
            } catch (error) {
                console.error('Buzz error:', error);
                gameState.hasBuzzed = false;
                updateBuzzerState();
            }
        }

        function updateBuzzerState() {
            if (gameState.hasBuzzed) {
                buzzBtn.className = 'w-64 h-64 bg-gradient-to-br from-green-400 via-green-500 to-green-600 rounded-full text-white font-black text-4xl shadow-2xl border-8 border-green-300 mx-auto block mb-6 cursor-not-allowed';
                buzzBtn.innerHTML = '‚úÖ<br>BUZZED!';
                buzzBtn.disabled = true;
            } else {
                buzzBtn.className = 'buzz-button w-64 h-64 bg-gradient-to-br from-yellow-400 via-yellow-500 to-orange-500 rounded-full text-black font-black text-4xl shadow-2xl border-8 border-yellow-300 hover:shadow-yellow-400/50 transition-all duration-300 mx-auto block mb-6';
                buzzBtn.innerHTML = 'üîî<br>BUZZ IN!';
                buzzBtn.disabled = false;
            }
        }

        function playCheer() {
            cheerSound.play().catch(() => {});
            cheerBtn.classList.add('cheer-animation');
            
            // Add floating emojis
            const emojis = ['üéâ', 'üéä', 'üëè', 'ü•≥', 'üéà'];
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.className = 'absolute text-2xl pointer-events-none';
                    emoji.style.left = Math.random() * 100 + '%';
                    emoji.style.top = '50%';
                    emoji.style.animation = 'confetti-fall 2s ease-out forwards';
                    document.body.appendChild(emoji);
                    
                    setTimeout(() => emoji.remove(), 2000);
                }, i * 100);
            }
            
            setTimeout(() => cheerBtn.classList.remove('cheer-animation'), 600);
        }

        function subscribeToGameUpdates() {
            // Subscribe to team changes (for buzzer clearing)
            supabase
                .channel('team-updates')
                .on('postgres_changes', 
                    { 
                        event: 'UPDATE', 
                        schema: 'public', 
                        table: 'teams',
                        filter: `id=eq.${gameState.teamId}`
                    }, 
                    (payload) => {
                        if (payload.new.buzzed_at === null && gameState.hasBuzzed) {
                            // Buzzer was cleared
                            gameState.hasBuzzed = false;
                            updateBuzzerState();
                            statusText.textContent = 'Ready to buzz in!';
                            saveGameState();
                        }
                    })
                .subscribe();

            // Subscribe to game state changes
            supabase
                .channel('game-updates')
                .on('postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'games',
                        filter: `id=eq.${gameState.gameId}`
                    },
                    (payload) => {
                        if (payload.new.status === 'scores_revealed' && !gameState.scoresRevealed) {
                            gameState.scoresRevealed = true;
                            showCelebration();
                        }
                    })
                .subscribe();
        }

        async function showCelebration() {
            try {
                // Get final team data to calculate place
                const { data: teams, error } = await supabase
                    .from('teams')
                    .select('id, name, score')
                    .eq('game_id', gameState.gameId)
                    .order('score', { ascending: true });

                if (!error && teams) {
                    const currentTeam = teams.find(t => t.id === gameState.teamId);
                    const place = calculatePlace(teams, currentTeam.score);
                    
                    // Show celebration
                    buzzerSection.style.display = 'none';
                    celebrationSection.style.display = 'block';
                    
                    // Play fanfare and show confetti
                    fanfareSound.play().catch(() => {});
                    startConfetti();
                    
                    // Set place message
                    if (place.tied) {
                        placeMessage.innerHTML = `It's a Tie!<br>You Got ${getOrdinal(place.position)} Place! üéâ`;
                    } else {
                        placeMessage.innerHTML = `You got ${getOrdinal(place.position)} Place! üéâ`;
                    }
                    
                    saveGameState();
                }
            } catch (error) {
                console.error('Error showing celebration:', error);
            }
        }

        function calculatePlace(teams, score) {
            const uniqueScores = [...new Set(teams.map(t => t.score))].sort((a, b) => a - b);
            const position = uniqueScores.indexOf(score) + 1;
            const tied = teams.filter(t => t.score === score).length > 1;
            
            return { position, tied };
        }

        function getOrdinal(num) {
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const v = num % 100;
            return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }

        function startConfetti() {
            confettiContainer.style.display = 'block';
            
            function createConfetti() {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confettiContainer.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 5000);
            }
            
            // Create initial burst
            for (let i = 0; i < 50; i++) {
                setTimeout(createConfetti, i * 100);
            }
            
            // Continue creating confetti
            gameState.confettiInterval = setInterval(() => {
                for (let i = 0; i < 3; i++) {
                    createConfetti();
                }
            }, 500);
        }

        function stopConfetti() {
            confettiContainer.style.display = 'none';
            if (gameState.confettiInterval) {
                clearInterval(gameState.confettiInterval);
            }
        }

        function leaveGame() {
            if (confirm('Are you sure you want to leave the game?')) {
                stopConfetti();
                localStorage.removeItem('buzzGameState');
                
                // Reset game state
                gameState = {
                    gameId: null,
                    teamId: null,
                    teamName: '',
                    gameCode: '',
                    hasBuzzed: false,
                    scoresRevealed: false
                };
                
                // Reset UI
                joinScreen.style.display = 'block';
                gameScreen.style.display = 'none';
                buzzerSection.style.display = 'block';
                celebrationSection.style.display = 'none';
                
                // Clear form
                gameCodeInput.value = '';
                teamNameInput.value = '';
                
                // Unsubscribe from updates
                supabase.removeAllChannels();
            }
        }

        // Handle page visibility changes (mobile browsers)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && gameState.gameId) {
                // Page became visible, check if we need to reconnect
                checkStoredGame();
            }
        });
    </script>
</body>
</html>
