<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buzz Game - Host Dashboard</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .narrow-layout {
            max-width: 500px;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(244, 63, 94, 0.4); }
            50% { box-shadow: 0 0 30px rgba(244, 63, 94, 0.8); }
        }
        
        .buzz-glow {
            animation: pulse-glow 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-indigo-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-6 narrow-layout">
        <!-- Header -->
        <div class="text-center mb-6">
            <img src="./public/logo.png" alt="Buzz Game Logo" class="mx-auto mb-4 w-24 h-24 object-contain">
            <h1 class="text-3xl font-bold text-yellow-400 mb-2">ðŸŽ¯ HOST DASHBOARD ðŸŽ¯</h1>
        </div>

        <!-- Game Setup Screen -->
        <div id="setup-screen" class="space-y-6">
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
                <h2 class="text-2xl font-bold text-center mb-6 text-yellow-400">Start New Game</h2>
                
                <button id="create-game-btn" 
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 px-6 rounded-xl text-xl hover:from-green-400 hover:to-emerald-500 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    CREATE GAME ðŸŽ®
                </button>
            </div>
        </div>

        <!-- Game Active Screen -->
        <div id="game-screen" style="display: none;" class="space-y-4">
            <!-- Game Code Display -->
            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-black rounded-2xl p-4 text-center font-bold shadow-2xl">
                <h3 class="text-lg mb-2">GAME CODE</h3>
                <div id="game-code-display" class="text-4xl font-black tracking-wider"></div>
                <p class="text-sm mt-2">Share this code with teams</p>
            </div>

            <!-- Teams List -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-yellow-400">Teams (<span id="team-count">0</span>)</h3>
                    <div class="space-x-2">
                        <button id="clear-all-btn" 
                                class="bg-gradient-to-r from-pink-500 to-rose-500 text-white font-medium py-2 px-4 rounded-lg text-sm hover:from-pink-400 hover:to-rose-400 transition-all duration-200 shadow">
                            CLEAR ALL
                        </button>
                    </div>
                </div>
                <div id="teams-list" class="space-y-2 min-h-[100px]">
                    <p class="text-white/60 text-center py-4">No teams joined yet</p>
                </div>
            </div>

            <!-- Buzz Order -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
                <h3 class="text-lg font-bold text-yellow-400 mb-4">Buzz In Order</h3>
                <div id="buzz-order" class="space-y-2 min-h-[60px]">
                    <p class="text-white/60 text-center py-2">No buzzes yet</p>
                </div>
            </div>

            <!-- Scoring Section -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
                <h3 class="text-lg font-bold text-yellow-400 mb-4">Final Scoring</h3>
                
                <div id="score-entry" class="space-y-3 mb-4">
                    <p class="text-white/80 text-sm">Enter final scores for each team:</p>
                    <div id="score-inputs" class="space-y-2">
                        <!-- Score inputs will be dynamically added here -->
                    </div>
                    
                    <button id="calculate-places-btn" 
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:from-blue-400 hover:to-purple-500 transition-all duration-200 shadow">
                        CALCULATE PLACES
                    </button>
                </div>
                
                <!-- Places Display -->
                <div id="places-display" style="display: none;" class="mt-4">
                    <h4 class="font-bold text-green-400 mb-3">Final Places (Low to High Score):</h4>
                    <div id="places-list" class="space-y-2 bg-black/20 rounded-lg p-3">
                        <!-- Places will be shown here -->
                    </div>
                    
                    <button id="reveal-places-btn" 
                            class="w-full mt-4 bg-gradient-to-r from-red-500 to-pink-600 text-white font-bold py-3 px-4 rounded-lg hover:from-red-400 hover:to-pink-500 transition-all duration-200 shadow-lg text-lg">
                        ðŸŽ‰ REVEAL PLACES ðŸŽ‰
                    </button>
                </div>
            </div>

            <!-- Game Controls -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
                <h3 class="text-lg font-bold text-yellow-400 mb-4">Game Controls</h3>
                <div class="space-y-3">
                    <button id="new-game-btn" 
                            class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:from-green-400 hover:to-emerald-500 transition-all duration-200 shadow">
                        START NEW GAME
                    </button>
                    
                    <button id="end-game-btn" 
                            class="w-full bg-gradient-to-r from-gray-600 to-gray-700 text-white font-medium py-2 px-4 rounded-lg hover:from-gray-500 hover:to-gray-600 transition-all duration-200 shadow text-sm">
                        END CURRENT GAME
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-message" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg" style="display: none;"></div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://tqpuxtswcuwruaqhompl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxcHV4dHN3Y3V3cnVhcWhvbXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEzOTU5ODEsImV4cCI6MjA0Njk3MTk4MX0.YHg6Y-6FiAfCGpFSvfRYdEe8Pt9gzHF5WTqN7wGIv5o';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let hostState = {
            gameId: null,
            gameCode: '',
            teams: [],
            buzzOrder: []
        };

        // DOM elements
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const createGameBtn = document.getElementById('create-game-btn');
        const gameCodeDisplay = document.getElementById('game-code-display');
        const teamCount = document.getElementById('team-count');
        const teamsList = document.getElementById('teams-list');
        const buzzOrder = document.getElementById('buzz-order');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const scoreInputs = document.getElementById('score-inputs');
        const calculatePlacesBtn = document.getElementById('calculate-places-btn');
        const placesDisplay = document.getElementById('places-display');
        const placesList = document.getElementById('places-list');
        const revealPlacesBtn = document.getElementById('reveal-places-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const endGameBtn = document.getElementById('end-game-btn');
        const statusMessage = document.getElementById('status-message');

        // Event listeners
        createGameBtn.addEventListener('click', createGame);
        clearAllBtn.addEventListener('click', clearAllBuzzers);
        calculatePlacesBtn.addEventListener('click', calculatePlaces);
        revealPlacesBtn.addEventListener('click', revealPlaces);
        newGameBtn.addEventListener('click', startNewGame);
        endGameBtn.addEventListener('click', endCurrentGame);

        // Generate random 6-digit game code
        function generateGameCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function createGame() {
            createGameBtn.textContent = 'CREATING...';
            createGameBtn.disabled = true;

            try {
                const gameCode = generateGameCode();
                
                // Check if code already exists (very unlikely but possible)
                const { data: existing, error: checkError } = await supabase
                    .from('games')
                    .select('id')
                    .eq('game_code', gameCode)
                    .single();

                if (existing) {
                    // Generate new code if collision
                    return createGame();
                }

                // Create new game
                const { data: game, error: gameError } = await supabase
                    .from('games')
                    .insert([{ 
                        game_code: gameCode,
                        status: 'active'
                    }])
                    .select()
                    .single();

                if (gameError) {
                    throw new Error('Failed to create game');
                }

                hostState.gameId = game.id;
                hostState.gameCode = gameCode;
                hostState.teams = [];
                hostState.buzzOrder = [];

                showGameScreen();
                subscribeToGameUpdates();
                showStatus('Game created successfully!', 'success');
                
            } catch (error) {
                console.error('Create game error:', error);
                showStatus('Failed to create game. Please try again.', 'error');
            } finally {
                createGameBtn.textContent = 'CREATE GAME ðŸŽ®';
                createGameBtn.disabled = false;
            }
        }

        function showGameScreen() {
            setupScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            gameCodeDisplay.textContent = hostState.gameCode;
            updateTeamsDisplay();
        }

        function subscribeToGameUpdates() {
            // Subscribe to team joins/leaves
            supabase
                .channel('team-changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'teams',
                        filter: `game_id=eq.${hostState.gameId}`
                    }, 
                    (payload) => {
                        if (payload.eventType === 'INSERT') {
                            hostState.teams.push(payload.new);
                            showStatus(`${payload.new.name} joined the game!`, 'success');
                        } else if (payload.eventType === 'UPDATE') {
                            const index = hostState.teams.findIndex(t => t.id === payload.new.id);
                            if (index >= 0) {
                                hostState.teams[index] = payload.new;
                            }
                        } else if (payload.eventType === 'DELETE') {
                            hostState.teams = hostState.teams.filter(t => t.id !== payload.old.id);
                            showStatus(`${payload.old.name} left the game`, 'info');
                        }
                        updateTeamsDisplay();
                        updateBuzzOrder();
                        generateScoreInputs();
                    })
                .subscribe();
        }

        function updateTeamsDisplay() {
            teamCount.textContent = hostState.teams.length;
            
            if (hostState.teams.length === 0) {
                teamsList.innerHTML = '<p class="text-white/60 text-center py-4">No teams joined yet</p>';
                return;
            }

            teamsList.innerHTML = hostState.teams.map(team => `
                <div class="flex justify-between items-center bg-white/5 rounded-lg p-3 ${team.buzzed_at ? 'buzz-glow border border-rose-400' : ''}">
                    <div>
                        <span class="font-medium">${team.name}</span>
                        ${team.buzzed_at ? '<span class="ml-2 text-rose-400 font-bold">ðŸ”” BUZZED</span>' : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        ${team.buzzed_at ? `
                            <button onclick="clearBuzzer(${team.id})" 
                                    class="bg-gradient-to-r from-pink-500 to-rose-500 text-white font-medium py-1 px-3 rounded text-xs hover:from-pink-400 hover:to-rose-400 transition-all duration-200 shadow">
                                CLEAR
                            </button>
                        ` : ''}
                        <button onclick="removeTeam(${team.id})" 
                                class="bg-red-600 text-white font-medium py-1 px-3 rounded text-xs hover:bg-red-500 transition-all duration-200">
                            REMOVE
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateBuzzOrder() {
            const buzzedTeams = hostState.teams
                .filter(team => team.buzzed_at)
                .sort((a, b) => new Date(a.buzzed_at) - new Date(b.buzzed_at));

            if (buzzedTeams.length === 0) {
                buzzOrder.innerHTML = '<p class="text-white/60 text-center py-2">No buzzes yet</p>';
                return;
            }

            buzzOrder.innerHTML = buzzedTeams.map((team, index) => {
                const buzzTime = new Date(team.buzzed_at).toLocaleTimeString([], {hour12: false});
                return `
                    <div class="flex justify-between items-center bg-rose-900/30 rounded-lg p-2 border border-rose-400">
                        <span class="font-bold text-rose-300">${index + 1}.</span>
                        <span class="font-medium">${team.name}</span>
                        <span class="text-xs text-rose-200">${buzzTime}</span>
                    </div>
                `;
            }).join('');
        }

        async function clearBuzzer(teamId) {
            try {
                const { error } = await supabase
                    .from('teams')
                    .update({ buzzed_at: null })
                    .eq('id', teamId);

                if (error) throw error;
                showStatus('Buzzer cleared', 'success');
            } catch (error) {
                console.error('Clear buzzer error:', error);
                showStatus('Failed to clear buzzer', 'error');
            }
        }

        async function clearAllBuzzers() {
            if (!confirm('Clear all team buzzers?')) return;

            try {
                const { error } = await supabase
                    .from('teams')
                    .update({ buzzed_at: null })
                    .eq('game_id', hostState.gameId);

                if (error) throw error;
                showStatus('All buzzers cleared', 'success');
            } catch (error) {
                console.error('Clear all buzzers error:', error);
                showStatus('Failed to clear buzzers', 'error');
            }
        }

        async function removeTeam(teamId) {
            const team = hostState.teams.find(t => t.id === teamId);
            if (!confirm(`Remove ${team.name} from the game?`)) return;

            try {
                const { error } = await supabase
                    .from('teams')
                    .delete()
                    .eq('id', teamId);

                if (error) throw error;
                showStatus(`${team.name} removed from game`, 'success');
            } catch (error) {
                console.error('Remove team error:', error);
                showStatus('Failed to remove team', 'error');
            }
        }

        function generateScoreInputs() {
            if (hostState.teams.length === 0) {
                scoreInputs.innerHTML = '<p class="text-white/60 text-center py-2">No teams to score</p>';
                return;
            }

            scoreInputs.innerHTML = hostState.teams.map(team => `
                <div class="flex justify-between items-center bg-white/5 rounded-lg p-2">
                    <label class="font-medium">${team.name}</label>
                    <input type="number" 
                           id="score-${team.id}" 
                           value="${team.score || 0}"
                           class="w-20 p-2 bg-white/20 border border-white/30 rounded text-white text-center"
                           min="0" max="9999">
                </div>
            `).join('');
        }

        async function calculatePlaces() {
            try {
                // Save all scores first
                const updates = [];
                for (const team of hostState.teams) {
                    const scoreInput = document.getElementById(`score-${team.id}`);
                    const score = parseInt(scoreInput.value) || 0;
                    updates.push({
                        id: team.id,
                        score: score
                    });
                }

                // Update all scores in database
                for (const update of updates) {
                    const { error } = await supabase
                        .from('teams')
                        .update({ score: update.score })
                        .eq('id', update.id);
                    
                    if (error) throw error;
                    
                    // Update local state
                    const team = hostState.teams.find(t => t.id === update.id);
                    if (team) team.score = update.score;
                }

                displayPlaces();
                placesDisplay.style.display = 'block';
                showStatus('Places calculated!', 'success');
                
            } catch (error) {
                console.error('Calculate places error:', error);
                showStatus('Failed to calculate places', 'error');
            }
        }

        function displayPlaces() {
            // Sort teams by score (lowest to highest)
            const sortedTeams = [...hostState.teams].sort((a, b) => (a.score || 0) - (b.score || 0));
            
            // Calculate places with tie handling
            const placesData = [];
            let currentPlace = 1;
            
            for (let i = 0; i < sortedTeams.length; i++) {
                const team = sortedTeams[i];
                const score = team.score || 0;
                
                // Check for ties
                const tiedTeams = sortedTeams.filter(t => (t.score || 0) === score);
                const isTie = tiedTeams.length > 1;
                
                placesData.push({
                    ...team,
                    place: currentPlace,
                    tied: isTie
                });
                
                // Skip places for tied teams
                if (i < sortedTeams.length - 1 && (sortedTeams[i + 1].score || 0) > score) {
                    currentPlace += tiedTeams.length;
                }
            }

            // Display places
            placesList.innerHTML = placesData.map(team => {
                const ordinal = getOrdinal(team.place);
                return `
                    <div class="flex justify-between items-center bg-gradient-to-r from-green-800/50 to-blue-800/50 rounded-lg p-3">
                        <div class="flex items-center space-x-3">
                            <span class="font-bold text-2xl text-yellow-400">${ordinal}</span>
                            <div>
                                <div class="font-bold">${team.name}</div>
                                ${team.tied ? '<span class="text-rose-300 text-sm font-bold">TIE!</span>' : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg">${team.score || 0} pts</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getOrdinal(num) {
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const v = num % 100;
            return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }

        async function revealPlaces() {
            if (!confirm('Reveal final places to all teams? This will end the game.')) return;

            try {
                // Update game status to trigger celebration on player devices
                const { error } = await supabase
                    .from('games')
                    .update({ status: 'scores_revealed' })
                    .eq('id', hostState.gameId);

                if (error) throw error;

                showStatus('Places revealed to all teams! ðŸŽ‰', 'success');
                revealPlacesBtn.style.display = 'none';
                
            } catch (error) {
                console.error('Reveal places error:', error);
                showStatus('Failed to reveal places', 'error');
            }
        }

        async function startNewGame() {
            if (!confirm('Start a new game? This will end the current game and remove all teams.')) return;

            try {
                // End current game
                if (hostState.gameId) {
                    await supabase
                        .from('games')
                        .update({ status: 'ended' })
                        .eq('id', hostState.gameId);
                }

                // Reset state
                hostState = {
                    gameId: null,
                    gameCode: '',
                    teams: [],
                    buzzOrder: []
                };

                // Show setup screen
                setupScreen.style.display = 'block';
                gameScreen.style.display = 'none';
                placesDisplay.style.display = 'none';

                // Unsubscribe from updates
                supabase.removeAllChannels();

                showStatus('Ready to create new game', 'success');
                
            } catch (error) {
                console.error('Start new game error:', error);
                showStatus('Error starting new game', 'error');
            }
        }

        async function endCurrentGame() {
            if (!confirm('End the current game? Teams will be disconnected.')) return;

            try {
                const { error } = await supabase
                    .from('games')
                    .update({ status: 'ended' })
                    .eq('id', hostState.gameId);

                if (error) throw error;

                showStatus('Game ended successfully', 'success');
                
                // Auto-transition to new game setup after 2 seconds
                setTimeout(() => {
                    startNewGame();
                }, 2000);
                
            } catch (error) {
                console.error('End game error:', error);
                showStatus('Error ending game', 'error');
            }
        }

        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            statusMessage.style.display = 'block';

            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        // Global functions for onclick handlers
        window.clearBuzzer = clearBuzzer;
        window.removeTeam = removeTeam;

        // Initialize
        window.addEventListener('load', () => {
            generateScoreInputs();
        });
    </script>
</body>
</html>
