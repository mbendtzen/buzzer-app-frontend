<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Host Dashboard - Get in the Game Show</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@keyframes quickFlash {
0% { opacity: 0; transform: scale(0.2); }
35% { opacity: 1; transform: scale(1.1); }
100% { opacity: 0; transform: scale(0.5); }
}

@keyframes pulse-glow {
0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.3); }
50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.6), 0 0 40px rgba(20, 184, 166, 0.4); }
}

@keyframes logo-glow {
0%, 100% { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3)); }
50% { filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.6)); }
}

.sparkle {
animation: quickFlash 0.25s ease-out;
pointer-events: none;
}

.buzzed-section-glow {
animation: pulse-glow 2s ease-in-out infinite;
}

.logo-glow {
animation: logo-glow 3s ease-in-out infinite;
}

body {
background: linear-gradient(135deg, #1e3a8a 0%, #312e81 50%, #1e1b4b 100%);
margin: 0;
font-family: 'Inter', system-ui, -apple-system, sans-serif;
font-size: 16px;
}

.copyright-footer {
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: rgba(0, 0, 0, 0.8);
color: white;
text-align: center;
padding: 8px;
font-size: 12px;
z-index: 1000;
}
</style>
</head>

<body>
<div id="app" class="relative min-h-screen w-full max-w-sm mx-auto overflow-hidden">
<!-- Sparkles Container -->
<div id="sparkles"></div>

<!-- Main Content -->
<div class="relative z-10 p-2 space-y-3 pb-16">
<!-- Header Section -->
<div class="text-center">
<img
src="logo.png"
alt="Get in the Game Show Logo"
class="logo-glow w-full max-w-md h-32 mx-auto mb-2 object-contain px-4"
onerror="this.style.display='none'"
/>
<h1 class="text-xl font-bold text-white mb-2 tracking-wider">üí´ HOST DASHBOARD üí´</h1>

<!-- Game Code Display -->
<div id="gameCodeSection" style="display: none;">
<div class="bg-white/10 backdrop-blur-md border border-yellow-400/60 rounded-xl p-3 mb-2">
<div class="text-yellow-400 font-bold text-xl mb-1">‚ú® GAME CODE ‚ú®</div>
<div id="gameCodeDisplay" class="text-white font-bold text-3xl tracking-widest font-mono">------</div>
</div>
</div>

<!-- Create Game Button -->
<div id="createGameSection">
<button
id="createGameBtn"
class="w-full py-3 px-3 text-lg font-bold rounded-xl border-2 border-yellow-400 shadow-2xl transition-all transform bg-gradient-to-r from-yellow-400 to-orange-500 text-black hover:scale-95 hover:shadow-xl active:scale-90"
>
üöÄ CREATE NEW GAME üöÄ
</button>
</div>
</div>

<!-- Game Active Sections -->
<div id="gameActiveSections" style="display: none;">
<!-- Buzzed In Section -->
<div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-xl p-3 shadow-2xl buzzed-section-glow">
<div class="flex justify-between items-center mb-2">
<h2 class="font-bold text-base" style="color: #5de1e6;">‚ö°Ô∏è BUZZED IN ‚ö°Ô∏è</h2>
<button
id="clearAllBtn"
class="font-bold py-1 px-2 rounded-lg text-sm hover:scale-95 transition-all transform active:scale-90 shadow-lg border border-gray-400 text-black"
style="background-color: #5de1e6;"
>
‚ùå CLEAR ALL
</button>
</div>
<div id="buzzedTeamsList">
<div class="text-white/60 text-center py-8 italic text-lg">
<div class="mb-2">No teams have buzzed in yet...</div>
<div class="text-sm">Teams will appear here when they buzz in</div>
</div>
</div>
</div>

<!-- All Teams Section -->
<div class="bg-white/10 backdrop-blur-md border border-purple-300/40 rounded-xl p-3 shadow-2xl">
<h2 class="font-bold text-base mb-2" style="color: #f8acee;">üë• ALL TEAMS (<span id="teamCount">0</span>) üë•</h2>
<div id="allTeamsList">
<div class="text-white/60 text-center py-2 italic text-base">No teams joined yet...</div>
</div>
</div>

<!-- Scoring Section -->
<div class="bg-white/10 backdrop-blur-md border border-yellow-400/60 rounded-xl p-3 shadow-2xl">
<h2 class="text-yellow-400 font-bold text-base mb-2">üèÜ SCORING üèÜ</h2>
<div id="scoringList" class="space-y-2 max-h-48 overflow-y-auto">
<div class="text-white/60 text-center py-2 italic text-base">No teams to score yet...</div>
</div>

<!-- Dramatic Reading Order -->
<div id="dramaticReadingSection" style="display: none;" class="mt-3 pt-3 border-t border-yellow-400/60">
<h3 class="text-yellow-400 font-bold text-sm mb-2">ü§© DRAMATIC READING ORDER ü§©</h3>
<div id="dramaticReadingList" class="space-y-1"></div>
</div>

<button
id="revealScoresBtn"
class="w-full mt-3 py-2 px-3 text-base font-bold rounded-xl border-2 border-yellow-400 shadow-2xl transition-all transform bg-gradient-to-r from-yellow-400 to-orange-500 text-black hover:scale-95 hover:shadow-xl active:scale-90"
style="display: none;"
>
üé§ REVEAL RANKINGS üéâ
</button>
</div>

<!-- Game Control -->
<div class="pt-2">
<button
id="endGameBtn"
class="w-full text-white font-bold py-2 px-3 rounded-xl border-2 border-pink-400 shadow-2xl hover:scale-95 hover:shadow-xl transition-all transform active:scale-90 text-base"
style="background-color: #cb0cea;"
>
üé¨ END GAME üé¨
</button>
</div>
</div>
</div>
</div>

<!-- Copyright Footer -->
<div class="copyright-footer">
Copyright 2025 Get in the Game Show, LLC. All Rights Reserved
</div>

<script>
(function() {
'use strict';

// Initialize Supabase - wrapped to avoid redeclaration
let supabaseClient;
try {
    const supabaseUrl = 'https://tqpuxtswcuwruaqhompl.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxcHV4dHN3Y3V3cnVhcWhvbXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NDUyMjQsImV4cCI6MjA3MzEyMTIyNH0.JF71Ap_FJG872iApuXaKW-vNN5TWPiJXvmz6PXWm4cU';
    
    if (!window.supabase) {
        console.error('Supabase library not loaded!');
        alert('Error: Database connection failed. Please refresh the page.');
        return;
    }
    
    supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
    console.log('Supabase initialized successfully');
} catch (error) {
    console.error('Error initializing Supabase:', error);
    alert('Error connecting to database. Please refresh the page.');
    return;
}

// Game state
let gameActive = false;
let gameCode = '';
let gameId = null;
let allTeams = [];
let buzzedTeams = [];
let scores = {};
let scoresRevealed = false;
let realtimeChannel = null;

// Audio for buzzer sound
async function playBuzzerSound() {
    try {
        const audio = new Audio('buzzer.mp3');
        await audio.play();
    } catch (e) {
        console.log('Buzzer sound failed:', e);
    }
}

// Sparkle effect
function createSparkle() {
    const shapes = ['‚ú¶', '‚Ä¢', '¬∑', '*', '‚úß', '‚ãÜ', '‚ó¶'];
    const sparklesContainer = document.getElementById('sparkles');
    
    for(let i = 0; i < 2; i++) {
        setTimeout(() => {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.style.position = 'absolute';
            sparkle.style.left = (Math.random() * 90 + 5) + '%';
            sparkle.style.top = (Math.random() * 90 + 5) + '%';
            sparkle.style.color = 'white';
            sparkle.style.fontSize = (Math.random() < 0.4 ? 6 : Math.random() < 0.7 ? 10 : 14) + 'px';
            sparkle.style.textShadow = '0 0 4px rgba(255,255,255,0.8)';
            sparkle.textContent = shapes[Math.floor(Math.random() * shapes.length)];
            sparkle.style.zIndex = '5';
            sparklesContainer.appendChild(sparkle);
            
            setTimeout(() => {
                sparkle.remove();
            }, 250);
        }, i * 50);
    }
}

setInterval(createSparkle, 150);

// Generate secure 6-digit game code
function generateGameCode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

// Supabase functions
async function createNewGame() {
    gameCode = generateGameCode();
    
    try {
        const { data, error } = await supabaseClient
            .from('games')
            .insert([{
                game_code: gameCode,
                status: 'active',
                created_at: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (error) {
            console.error('Error creating game:', error);
            alert('Error creating game: ' + error.message);
            return null;
        }
        
        gameId = data.id;
        console.log('Game created:', data);
        return data;
    } catch (error) {
        console.error('Exception creating game:', error);
        alert('Error creating game. Please check your connection and try again.');
        return null;
    }
}

async function loadTeams() {
    if (!gameId) return;
    
    const { data, error } = await supabaseClient
        .from('teams')
        .select('*')
        .eq('game_id', gameId)
        .order('created_at', { ascending: true });
    
    if (error) {
        console.error('Error loading teams:', error);
        return;
    }
    
    allTeams = data || [];
    buzzedTeams = allTeams.filter(team => team.buzzed_at).sort((a, b) => new Date(a.buzzed_at) - new Date(b.buzzed_at));
    
    const currentBuzzedCount = buzzedTeams.length;
    if (currentBuzzedCount > (window.lastBuzzedCount || 0)) {
        playBuzzerSound();
    }
    window.lastBuzzedCount = currentBuzzedCount;
    
    updateAllDisplays();
}

async function clearBuzzer(teamId) {
    const { error } = await supabaseClient
        .from('teams')
        .update({ buzzed_at: null })
        .eq('id', teamId);
    
    if (error) {
        console.error('Error clearing buzzer:', error);
        return;
    }
    
    loadTeams();
}

async function clearAllBuzzers() {
    const { error } = await supabaseClient
        .from('teams')
        .update({ buzzed_at: null })
        .eq('game_id', gameId);
    
    if (error) {
        console.error('Error clearing all buzzers:', error);
        return;
    }
    
    loadTeams();
}

async function removeTeam(teamId) {
    if (!confirm('Are you sure you want to remove this team?')) return;
    
    const { error } = await supabaseClient
        .from('teams')
        .delete()
        .eq('id', teamId);
    
    if (error) {
        console.error('Error removing team:', error);
        return;
    }
    
    loadTeams();
}

async function updateScore(teamId, score) {
    scores[teamId] = score;
    updateScoringDisplay();
    
    const { error } = await supabaseClient
        .from('teams')
        .update({ score: parseInt(score) || 0 })
        .eq('id', teamId);
    
    if (error) {
        console.error('Error updating score:', error);
    }
}

async function revealScores() {
    console.log('Revealing scores...');
    
    try {
        new Audio('fanfare.mp3').play().catch(() => {});
    } catch (e) {}
    
    const placementsData = calculatePlacements();
    console.log('Calculated placements:', placementsData);
    
    const cleanData = {};
    Object.keys(placementsData).forEach(teamId => {
        cleanData[teamId] = {
            place: placementsData[teamId].place,
            score: placementsData[teamId].score,
            isTie: placementsData[teamId].isTie
        };
    });
    
    const { error } = await supabaseClient
        .from('games')
        .update({
            status: 'scores_revealed',
            scores_data: cleanData
        })
        .eq('id', gameId);
    
    if (error) {
        console.error('Error revealing scores:', error);
        return;
    }
    
    console.log('Scores revealed successfully!');
    scoresRevealed = true;
    const btn = document.getElementById('revealScoresBtn');
    btn.textContent = 'üéâ RANKINGS REVEALED! üéâ';
    btn.className = 'w-full mt-3 py-2 px-3 text-base font-bold rounded-xl border-2 border-cyan-400 shadow-2xl cursor-default bg-cyan-600 text-white';
}

function calculatePlacements() {
    console.log('Calculating placements for teams:', allTeams);
    console.log('Current scores:', scores);
    
    const teamsWithScores = allTeams.map(team => ({
        ...team,
        score: parseInt(scores[team.id]) || team.score || 0
    }));
    
    console.log('Teams with scores:', teamsWithScores);
    
    teamsWithScores.sort((a, b) => b.score - a.score);
    console.log('Sorted teams:', teamsWithScores);
    
    const placements = {};
    let currentPlace = 1;
    
    for (let i = 0; i < teamsWithScores.length; i++) {
        const team = teamsWithScores[i];
        
        if (i > 0 && team.score === teamsWithScores[i-1].score) {
            placements[team.id] = {
                place: placements[teamsWithScores[i-1].id].place,
                score: team.score,
                isTie: true
            };
        } else {
            placements[team.id] = {
                place: currentPlace,
                score: team.score,
                isTie: false
            };
        }
        
        currentPlace = i + 2;
    }
    
    const placeCounts = {};
    Object.values(placements).forEach(p => {
        placeCounts[p.place] = (placeCounts[p.place] || 0) + 1;
    });
    
    Object.keys(placements).forEach(teamId => {
        if (placeCounts[placements[teamId].place] > 1) {
            placements[teamId].isTie = true;
        }
    });
    
    console.log('Final placements:', placements);
    return placements;
}

async function endGame() {
    if (!gameId || !confirm('Are you sure you want to end this game? This will disconnect all players.')) {
        return;
    }
    
    const { error } = await supabaseClient
        .from('games')
        .update({ status: 'ended' })
        .eq('id', gameId);
    
    if (error) {
        console.error('Error ending game:', error);
    }
    
    if (realtimeChannel) {
        supabaseClient.removeChannel(realtimeChannel);
    }
    
    gameActive = false;
    gameCode = '';
    gameId = null;
    allTeams = [];
    buzzedTeams = [];
    scores = {};
    scoresRevealed = false;
    window.lastBuzzedCount = 0;
    
    document.getElementById('createGameSection').style.display = 'block';
    document.getElementById('gameCodeSection').style.display = 'none';
    document.getElementById('gameActiveSections').style.display = 'none';
}

function setupRealtime() {
    if (realtimeChannel) {
        supabaseClient.removeChannel(realtimeChannel);
    }
    
    realtimeChannel = supabaseClient
        .channel(`game_${gameId}`)
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'teams', filter: `game_id=eq.${gameId}` },
            (payload) => {
                console.log('Team change:', payload);
                loadTeams();
            }
        )
        .subscribe();
}

function updateAllTeamsDisplay() {
    const container = document.getElementById('allTeamsList');
    const teamCount = document.getElementById('teamCount');
    
    teamCount.textContent = allTeams.length;
    
    if (allTeams.length === 0) {
        container.innerHTML = '<div class="text-white/60 text-center py-2 italic text-base">No teams joined yet...</div>';
        return;
    }
    
    const sortedTeams = [...allTeams].sort((a, b) => a.name.localeCompare(b.name));
    
    container.innerHTML = sortedTeams.map(team => `
        <div class="p-2 rounded-lg font-bold mb-1 transition-all text-base ${team.buzzed_at ? 'border border-yellow-400 transform scale-105' : ''} text-white hover:scale-102 shadow-md" style="background-color: #0a2b8a;">
            <div class="flex items-center justify-between">
                <span>${team.name}</span>
                <div class="flex items-center space-x-2">
                    ${team.buzzed_at ? '<span class="text-center px-2 py-1 rounded text-xs font-bold" style="color: #fbbf24; font-weight: bold;"><em>*BUZZED IN!*</em> üõéÔ∏è</span>' : ''}
                    <button onclick="removeTeam(${team.id})" class="text-xs text-white px-2 py-1 rounded hover:scale-95 border" style="background-color: #bf0ddd; border-color: #f8acee;">REMOVE</button>
                </div>
            </div>
        </div>
    `).join('');
}

function updateBuzzedTeamsDisplay() {
    const container = document.getElementById('buzzedTeamsList');
    
    if (buzzedTeams.length === 0) {
        container.innerHTML = '<div class="text-white/60 text-center py-8 italic text-lg"><div class="mb-2">No teams have buzzed in yet...</div><div class="text-sm">Teams will appear here when they buzz in</div></div>';
        return;
    }
    
    container.innerHTML = buzzedTeams.map((team, index) => `
        <div class="flex items-center justify-between text-white p-2 rounded-lg mb-1 shadow-lg transform hover:scale-102 transition-all border border-yellow-400" style="background-color: #6639ca;">
            <div class="flex items-center space-x-2">
                <span class="bg-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold shadow-inner" style="color: #6639ca;">
                    ${index + 1}
                </span>
                <span class="font-bold text-base text-white">${team.name}</span>
            </div>
            <button
                onclick="clearBuzzer(${team.id})"
                class="text-white px-2 py-1 rounded-lg text-sm hover:scale-95 transition-all transform active:scale-90 font-bold border border-gray-400"
                style="background-color: #5de1e6; color: black;"
            >
                üßπ CLEAR
            </button>
        </div>
    `).join('');
}

function updateScoringDisplay() {
    const container = document.getElementById('scoringList');
    const revealBtn = document.getElementById('revealScoresBtn');
    const dramaticSection = document.getElementById('dramaticReadingSection');
    
    if (allTeams.length === 0) {
        container.innerHTML = '<div class="text-white/60 text-center py-2 italic text-base">No teams to score yet...</div>';
        revealBtn.style.display = 'none';
        return;
    }
    
    const sortedTeams = [...allTeams].sort((a, b) => a.name.localeCompare(b.name));
    
    container.innerHTML = sortedTeams.map(team => `
        <div class="flex items-center space-x-2 mb-2 p-2 bg-white/5 rounded-lg">
            <div class="flex-1 text-white font-bold text-base truncate">
                ${team.name}
            </div>
            <input
                type="number"
                id="score_${team.id}"
                value="${scores[team.id] !== undefined ? scores[team.id] : (team.score || '')}"
                onchange="updateScore(${team.id}, this.value)"
                class="w-16 h-8 text-center font-bold bg-white/20 text-white border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all text-base"
                placeholder="0"
            />
        </div>
    `).join('');
    
    allTeams.forEach(team => {
        if (scores[team.id] === undefined) {
            scores[team.id] = team.score || '';
        }
    });
    
    const hasScores = Object.values(scores).some(score => score !== '' && score !== null);
    
    if (hasScores) {
        revealBtn.style.display = 'block';
        dramaticSection.style.display = 'block';
        
        const placements = calculatePlacements();
        const sortedForReading = allTeams
            .map(team => ({ ...team, ...placements[team.id] }))
            .sort((a, b) => a.score - b.score);
        
        document.getElementById('dramaticReadingList').innerHTML = sortedForReading.map(team => `
            <div class="flex justify-between text-white text-base bg-white/10 p-2 rounded">
                <span>${getOrdinal(team.place)} Place: ${team.name}</span>
                <span class="font-bold text-yellow-400">${team.score}</span>
            </div>
        `).join('');
    } else {
        revealBtn.style.display = 'none';
        dramaticSection.style.display = 'none';
    }
}

function getOrdinal(num) {
    const suffixes = ['th', 'st', 'nd', 'rd'];
    const v = num % 100;
    return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
}

function updateAllDisplays() {
    updateAllTeamsDisplay();
    updateBuzzedTeamsDisplay();
    updateScoringDisplay();
}

// Event listeners
document.getElementById('createGameBtn').addEventListener('click', async function() {
    console.log('Create game button clicked');
    const btn = this;
    btn.disabled = true;
    btn.textContent = '‚è≥ CREATING...';
    
    const gameData = await createNewGame();
    
    if (!gameData) {
        btn.disabled = false;
        btn.textContent = 'üöÄ CREATE NEW GAME üöÄ';
        return;
    }
    
    gameActive = true;
    window.lastBuzzedCount = 0;
    
    document.getElementById('gameCodeDisplay').textContent = gameCode;
    document.getElementById('createGameSection').style.display = 'none';
    document.getElementById('gameCodeSection').style.display = 'block';
    document.getElementById('gameActiveSections').style.display = 'block';
    
    setupRealtime();
    loadTeams();
});

document.getElementById('clearAllBtn').addEventListener('click', clearAllBuzzers);
document.getElementById('revealScoresBtn').addEventListener('click', revealScores);
document.getElementById('endGameBtn').addEventListener('click', endGame);

// Make functions global for onclick handlers
window.clearBuzzer = clearBuzzer;
window.updateScore = updateScore;
window.removeTeam = removeTeam;

console.log('Host dashboard loaded successfully');

})();
</script>
</body>
</html>