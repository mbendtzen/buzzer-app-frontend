<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Player Dashboard - Get in the Game Show</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@keyframes quickFlash {
0% { opacity: 0; transform: scale(0.2); }
35% { opacity: 1; transform: scale(1.1); }
100% { opacity: 0; transform: scale(0.5); }
}

@keyframes buzzer-glow {
0%, 100% { box-shadow: 0 0 30px rgba(255, 193, 7, 0.4); }
50% { box-shadow: 0 0 50px rgba(255, 193, 7, 0.8); }
}

@keyframes buzzer-pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.02); }
}

@keyframes fireworkConfetti {
0% { 
transform: translate(0, 0) rotate(0deg) scale(1);
opacity: 1;
}
25% {
transform: translate(var(--dx), var(--dy)) rotate(90deg) scale(0.8);
opacity: 1;
}
50% {
transform: translate(calc(var(--dx) * 1.5), calc(var(--dy) * 1.5)) rotate(180deg) scale(0.6);
opacity: 0.8;
}
100% { 
transform: translate(calc(var(--dx) * 2), calc(var(--dy) * 2)) rotate(360deg) scale(0.2);
opacity: 0;
}
}

@keyframes float-up {
0% { transform: translateY(0) scale(1); opacity: 1; }
100% { transform: translateY(-200px) scale(1.5); opacity: 0; }
}

@keyframes glow-pulse {
0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.5); }
50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.8), 0 0 40px rgba(20, 184, 166, 0.4); }
}

@keyframes qr-glow {
0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.3); }
50% { box-shadow: 0 0 25px rgba(255, 255, 255, 0.6), 0 0 35px rgba(255, 193, 7, 0.4); }
}

@keyframes logo-glow {
0%, 100% { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3)); }
50% { filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.6)); }
}

.sparkle {
animation: quickFlash 0.25s ease-out;
pointer-events: none;
}

.buzzer-glow {
animation: buzzer-glow 2s ease-in-out infinite, buzzer-pulse 3s ease-in-out infinite;
}

.confetti-piece {
position: absolute;
animation: fireworkConfetti 2.5s ease-out forwards;
z-index: 1000;
width: 6px;
height: 6px;
}

.party-emoji {
position: absolute;
animation: float-up 4s ease-out forwards;
z-index: 100;
}

.celebration-text {
animation: glow-pulse 2s ease-in-out infinite;
}

.qr-box-glow {
animation: qr-glow 3s ease-in-out infinite;
}

.logo-glow {
animation: logo-glow 3s ease-in-out infinite;
}

body {
background: linear-gradient(135deg, #1e3a8a 0%, #312e81 50%, #1e1b4b 100%);
margin: 0;
font-family: 'Inter', system-ui, -apple-system, sans-serif;
min-height: 100vh;
overflow-x: hidden;
}

.copyright-footer {
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: rgba(0, 0, 0, 0.8);
color: white;
text-align: center;
padding: 8px;
font-size: 12px;
z-index: 1000;
}

/* Fix for game code input text cutting off */
.game-code-input {
font-size: 18px;
line-height: 1.2;
padding: 12px !important;
}

/* Team name input styling */
.team-name-input {
font-size: 18px;
line-height: 1.2;
padding: 12px !important;
}

/* Turquoise button styling */
.turquoise-button {
background: linear-gradient(to right, #06b6d4, #0891b2);
}

.turquoise-button:hover {
background: linear-gradient(to right, #0891b2, #0e7490);
}
</style>
</head>
<body>
<div id="app" class="relative min-h-screen overflow-hidden">
<!-- Sparkles Container -->
<div id="sparkles"></div>

<!-- Entry Screen -->
<div id="entryScreen" class="min-h-screen flex flex-col items-center justify-center p-4">
<div class="mb-8 text-center">
<img
src="logo.png"
alt="Get in the Game Show Logo"
class="logo-glow w-full max-w-md h-32 mx-auto mb-4 object-contain px-4"
onerror="this.style.display='none'"
/>
<div class="text-white text-3xl font-bold mb-2">‚ö° GET EXCITED ‚ö°</div>
</div>

<div class="w-full max-w-sm">
<div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
<div class="text-white text-lg font-medium mb-6 text-center">Ready to play? ü§©</div>
<div class="space-y-4">
<div>
<input
type="text"
id="gameCodeInput"
class="game-code-input w-full bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 text-center font-bold uppercase tracking-wider"
placeholder="Enter 6-digit code"
maxlength="6"
/>
</div>
<button
id="joinGameBtn"
class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-bold py-4 px-6 rounded-xl text-xl hover:from-yellow-300 hover:to-orange-400 transform hover:scale-105 transition-all duration-200 shadow-lg"
>
JOIN GAME üöÄ
</button>
</div>
</div>
</div>
</div>

<!-- Team Setup Screen -->
<div id="teamSetupScreen" class="min-h-screen flex flex-col items-center justify-center p-4" style="display: none;">
<div class="mb-8 text-center">
<img
src="logo.png"
alt="Get in the Game Show Logo"
class="logo-glow w-full max-w-md h-32 mx-auto mb-4 object-contain px-4"
onerror="this.style.display='none'"
/>
<div class="text-white text-2xl font-bold">‚≠êÔ∏è YAY! Welcome to the game! ‚≠êÔ∏è</div>
</div>

<div class="w-full max-w-sm">
<div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
<div class="text-white text-lg font-medium mb-6 text-center">Now come up with a team name! üí´</div>
<div class="space-y-4">
<div>
<input
type="text"
id="teamNameInput"
class="team-name-input w-full bg-white/20 border border-white/30 rounded-xl text-white placeholder-white/60 text-center font-bold"
placeholder="Enter your team name"
maxlength="40"
/>
<div class="text-right text-white/60 text-sm mt-2">
<span id="charCount">0</span>/40 characters
</div>
</div>
<button
id="submitTeamBtn"
class="w-full turquoise-button text-white font-bold py-4 px-6 rounded-xl text-xl transform hover:scale-105 transition-all duration-200 shadow-lg"
>
LET'S PLAY! üöÄ
</button>
</div>
</div>
</div>
</div>

<!-- Dashboard Screen -->
<div id="dashboardScreen" class="min-h-screen flex flex-col p-2 pb-16" style="display: none;">
<!-- Header -->
<div class="text-center mb-4">
<img
src="logo.png"
alt="Get in the Game Show Logo"
class="logo-glow w-full max-w-md h-32 mx-auto mb-2 object-contain px-4"
onerror="this.style.display='none'"
/>
<h1 class="text-2xl font-bold text-white">‚ö° TEAM DASHBOARD ‚ö°</h1>
</div>

<!-- Team Info Box -->
<div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-4 mb-4 shadow-2xl">
<div class="text-center">
<div class="text-white text-sm font-bold mb-1">TEAM</div>
<h2 id="teamNameDisplay" class="text-xl font-bold mb-1" style="color: #5de1e6;">‚≠ê Team Name ‚≠ê</h2>
<p class="text-white text-lg mb-3 font-bold">is here to PLAY! ü•≥</p>
<div class="flex space-x-3">
<button
id="cheerBtn"
class="flex-1 text-white border-2 border-purple-300 font-bold py-2 px-1 rounded-lg transition-all transform hover:scale-95 shadow-lg text-base"
style="background-color: #6639ca;"
>
CHEER! üôå
</button>
<button
id="exitGameBtn"
class="flex-1 text-white border-2 font-bold py-2 px-1 rounded-lg shadow-lg text-base transition-all transform hover:scale-95"
style="background-color: #bf0ddd; border-color: #f8acee;"
>
EXIT üé¨
</button>
</div>
</div>
</div>

<!-- QR Code Message Box -->
<div id="qrSection" class="text-center bg-white/10 backdrop-blur-md border border-cyan-400/60 rounded-2xl p-3 mb-4 shadow-lg qr-box-glow">
<div class="text-white text-sm leading-relaxed">
üíé <strong>Scan QR code on the scoresheet to join our Frequent Fun Program and earn rewards just for playing!</strong> üíé
</div>
</div>

<!-- Giant 3D Buzzer Button -->
<div id="buzzerSection" class="flex-1 flex flex-col items-center justify-center mb-4">
<button
id="buzzerBtn"
class="buzzer-glow w-11/12 aspect-square max-w-sm rounded-full text-center font-bold bg-gradient-to-b from-yellow-400 via-yellow-500 to-yellow-600 text-blue-900 relative shadow-2xl mb-3"
>
<div class="flex flex-col items-center justify-center h-full relative z-10">
<div class="text-lg leading-tight mb-1 font-black">GET READY TO</div>
<div class="text-lg leading-tight mb-3 font-black">GET IN THE GAME!</div>
<div class="text-6xl mb-2">üö®</div>
<div class="text-2xl font-black">TAP TO BUZZ!</div>
</div>
<!-- 3D Button Effect Ring -->
<div class="absolute inset-2 rounded-full bg-gradient-to-b from-yellow-300 to-yellow-400 opacity-30"></div>
<div class="absolute inset-4 rounded-full bg-gradient-to-b from-yellow-200 to-yellow-300 opacity-20"></div>
</button>

<!-- Game Code Display -->
<div class="bg-white/10 backdrop-blur-md border border-white/30 rounded-lg px-4 py-2">
<div class="text-white/70 text-xs text-center mb-1">GAME CODE</div>
<div id="gameCodeDisplay" class="text-white font-bold text-lg text-center tracking-wider font-mono">------</div>
</div>
</div>
</div>

<!-- Celebration Screen -->
<div id="celebrationScreen" class="min-h-screen flex flex-col items-center justify-center p-4 pb-16" style="display: none;">
<div id="confettiContainer"></div>
<div class="text-center space-y-6">
<img
src="logo.png"
alt="Get in the Game Show Logo"
class="logo-glow w-full max-w-md h-32 mx-auto object-contain px-4"
onerror="this.style.display='none'"
/>
<div id="placementMessage" class="text-4xl font-bold text-white celebration-text mb-6">
üéâ You got 1st place! üéâ
</div>
<div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 celebration-text">
<div class="text-2xl font-bold text-white mb-4">
You just earned 1000 sMiles! ü§©
</div>
<div class="text-lg text-white mb-4">
Scan QR code on scoresheet to join Frequent Fun Program and earn your first bonus gift! üéÅ
</div>
<button
id="exitCelebrationBtn"
class="w-full text-white border-2 font-bold py-3 px-4 rounded-lg shadow-lg text-base transition-all transform hover:scale-95"
style="background-color: #bf0ddd; border-color: #f8acee;"
>
EXIT GAME üé¨
</button>
</div>
</div>
</div>

<!-- Copyright Footer -->
<div class="copyright-footer">
Copyright 2025 Get in the Game Show, LLC. All Rights Reserved
</div>

<script>
// Initialize Supabase
const supabaseUrl = 'https://tqpuxtswcuwruaqhompl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxcHV4dHN3Y3V3cnVhcWhvbXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NDUyMjQsImV4cCI6MjA3MzEyMTIyNH0.JF71Ap_FJG872iApuXaKW-vNN5TWPiJXvmz6PXWm4cU';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Game state
let currentScreen = 'entry';
let gameCode = '';
let teamName = '';
let teamId = null;
let gameId = null;
let isBuzzed = false;
let realtimeChannel = null;

// Enhanced game state persistence - use sessionStorage as fallback with memory backup
const STORAGE_KEY = 'gitg_game_state';
const EXPIRY_HOURS = 6;

function saveGameState() {
const state = {
gameCode,
teamName,
gameId,
teamId,
isBuzzed,
timestamp: Date.now()
};

// Try sessionStorage first (persists through refresh but not tab close)
try {
sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state));
} catch (e) {
console.log('SessionStorage not available');
}

// Also save to window property as backup
window.gameState = state;
}

function loadGameState() {
let state = null;

// Try sessionStorage first
try {
const stored = sessionStorage.getItem(STORAGE_KEY);
if (stored) {
state = JSON.parse(stored);
}
} catch (e) {
console.log('Could not load from sessionStorage');
}

// Fallback to window property
if (!state && window.gameState) {
state = window.gameState;
}

if (!state || !state.gameCode) return null;

// Check expiry
const EXPIRY = EXPIRY_HOURS * 60 * 60 * 1000;
if (Date.now() - state.timestamp > EXPIRY) {
clearGameState();
return null;
}

return state;
}

function clearGameState() {
try {
sessionStorage.removeItem(STORAGE_KEY);
} catch (e) {}
window.gameState = null;
}

// Audio functions - prioritize buzzer.mp3
async function playBuzzerSound() {
try {
const audio = new Audio('buzzer.mp3');
await audio.play();
} catch (e) {
console.log('Buzzer sound failed:', e);
}
}

function playClappingSound() {
try {
new Audio('clapping.mp3').play().catch(() => {});
} catch (e) {}
}

function playFanfareSound() {
try {
new Audio('fanfare.mp3').play().catch(() => {});
} catch (e) {}
}

// Sparkle effect
function createSparkle() {
const shapes = ['‚ú¶', '‚Ä¢', '¬∑', '*', '‚úß', '‚ãÜ', '‚ó¶'];
const sparklesContainer = document.getElementById('sparkles');

for(let i = 0; i < 3; i++) {
setTimeout(() => {
const sparkle = document.createElement('div');
sparkle.className = 'sparkle';
sparkle.style.position = 'absolute';
sparkle.style.left = (Math.random() * 90 + 5) + '%';
sparkle.style.top = (Math.random() * 90 + 5) + '%';
sparkle.style.color = 'white';
sparkle.style.fontSize = (Math.random() < 0.4 ? 6 : Math.random() < 0.7 ? 10 : 14) + 'px';
sparkle.style.textShadow = '0 0 4px rgba(255,255,255,0.8)';
sparkle.textContent = shapes[Math.floor(Math.random() * shapes.length)];
sparkle.style.zIndex = '5';
sparklesContainer.appendChild(sparkle);

setTimeout(() => {
sparkle.remove();
}, 250);
}, i * 50);
}
}

setInterval(createSparkle, 100);

// Screen management
function showScreen(screen) {
document.getElementById('entryScreen').style.display = 'none';
document.getElementById('teamSetupScreen').style.display = 'none';
document.getElementById('dashboardScreen').style.display = 'none';
document.getElementById('celebrationScreen').style.display = 'none';

if (screen === 'entry') {
document.getElementById('entryScreen').style.display = 'flex';
} else if (screen === 'teamSetup') {
document.getElementById('teamSetupScreen').style.display = 'flex';
} else if (screen === 'dashboard') {
document.getElementById('dashboardScreen').style.display = 'flex';
// Update game code display
document.getElementById('gameCodeDisplay').textContent = gameCode || '------';
} else if (screen === 'celebration') {
document.getElementById('celebrationScreen').style.display = 'flex';
}

currentScreen = screen;
}

// Enhanced party effects
function createPartyEmojis() {
const emojis = ['üéâ', 'üéä', 'ü•≥', 'üéà', '‚ú®', 'üåü', 'üí´', 'üéÜ'];
for (let i = 0; i < 15; i++) {
setTimeout(() => {
const emoji = document.createElement('div');
emoji.className = 'party-emoji';
emoji.style.position = 'absolute';
emoji.style.left = Math.random() * 100 + '%';
emoji.style.bottom = '0px';
emoji.style.fontSize = '20px';
emoji.style.zIndex = '100';
emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
document.body.appendChild(emoji);
setTimeout(() => emoji.remove(), 4000);
}, i * 150);
}
}

function createFireworkConfetti() {
const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7'];
const container = document.getElementById('confettiContainer');
const screenWidth = window.innerWidth;
const screenHeight = window.innerHeight;

// Create multiple explosion points
const explosionPoints = [
{ x: screenWidth * 0.2, y: screenHeight * 0.3 },
{ x: screenWidth * 0.8, y: screenHeight * 0.3 },
{ x: screenWidth * 0.5, y: screenHeight * 0.2 },
{ x: screenWidth * 0.3, y: screenHeight * 0.5 },
{ x: screenWidth * 0.7, y: screenHeight * 0.5 }
];

explosionPoints.forEach((point, explosionIndex) => {
// Create 8-12 pieces per explosion point
const piecesCount = 8 + Math.random() * 4;

for (let i = 0; i < piecesCount; i++) {
setTimeout(() => {
const confetti = document.createElement('div');
confetti.className = 'confetti-piece';
confetti.style.left = point.x + 'px';
confetti.style.top = point.y + 'px';
confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
confetti.style.zIndex = '1000';

// Calculate random explosion direction
const angle = (Math.PI * 2 * i) / piecesCount + (Math.random() - 0.5) * 0.5;
const distance = 100 + Math.random() * 150;
const dx = Math.cos(angle) * distance;
const dy = Math.sin(angle) * distance;

// Set CSS custom properties for animation
confetti.style.setProperty('--dx', dx + 'px');
confetti.style.setProperty('--dy', dy + 'px');

container.appendChild(confetti);

setTimeout(() => confetti.remove(), 2500);
}, i * 20 + explosionIndex * 100);
}
});
}

// Supabase functions
async function validateGameCode(code) {
try {
const { data, error } = await supabase
.from('games')
.select('id, status')
.eq('game_code', code)
.single();

if (error || !data) {
console.log('Game validation error:', error);
return null;
}

// Allow active or scores_revealed games for reconnection
if (data.status === 'active' || data.status === 'scores_revealed') {
return data.id;
}

return null;
} catch (e) {
console.error('Error validating game code:', e);
return null;
}
}

async function attemptReconnection() {
const savedState = loadGameState();
if (!savedState) return false;

console.log('Attempting reconnection with state:', savedState);

// Validate game still exists and is active
const validGameId = await validateGameCode(savedState.gameCode);
if (!validGameId) {
console.log('Game no longer valid, clearing state');
clearGameState();
return false;
}

// Check if team still exists in game
try {
const { data: existingTeam, error } = await supabase
.from('teams')
.select('*')
.eq('game_id', validGameId)
.eq('name', savedState.teamName)
.single();

if (error || !existingTeam) {
console.log('Team not found, clearing state');
clearGameState();
return false;
}

// Restore game state
gameCode = savedState.gameCode;
teamName = savedState.teamName;
gameId = validGameId;
teamId = existingTeam.id;
isBuzzed = !!existingTeam.buzzed_at; // Sync from database

document.getElementById('teamNameDisplay').innerHTML = `‚≠ê ${teamName} ‚≠ê`;
document.getElementById('teamNameDisplay').style.color = '#5de1e6';

// Set buzzer state based on database
if (isBuzzed) {
setBuzzerToBuzzedState();
} else {
resetBuzzerToReady();
}

// Check if game is in scores_revealed state
const { data: gameData } = await supabase
.from('games')
.select('status, scores_data')
.eq('id', gameId)
.single();

if (gameData && gameData.status === 'scores_revealed' && gameData.scores_data) {
try {
const placements = gameData.scores_data; // No JSON.parse needed with jsonb
const myPlacement = placements[teamId];
if (myPlacement) {
showCelebration(myPlacement);
setupRealtime();
return true;
}
} catch (e) {
console.error('Error parsing scores data on reconnect:', e);
}
}

setupRealtime();
showScreen('dashboard');
console.log('Successfully reconnected');
return true;
} catch (e) {
console.error('Error during reconnection:', e);
clearGameState();
return false;
}
}

async function joinGame(code, name) {
const validGameId = await validateGameCode(code);
if (!validGameId) {
alert('Invalid game code or game not active!');
return false;
}

// Check if team name already exists in this game
const { data: existingTeam } = await supabase
.from('teams')
.select('id')
.eq('game_id', validGameId)
.eq('name', name)
.single();

if (existingTeam) {
alert('Team name already taken in this game!');
return false;
}

// Create new team
const { data, error } = await supabase
.from('teams')
.insert([{
game_id: validGameId,
name: name,
created_at: new Date().toISOString()
}])
.select()
.single();

if (error) {
console.error('Error joining game:', error);
alert('Error joining game. Please try again.');
return false;
}

gameId = validGameId;
teamId = data.id;
isBuzzed = false;
saveGameState();
return true;
}

async function buzzIn() {
if (!teamId || isBuzzed) return false;

// INSTANT visual and audio feedback
isBuzzed = true;
playBuzzerSound();
setBuzzerToBuzzedState();
saveGameState();

// Add vibration
if ('vibrate' in navigator) {
navigator.vibrate([100, 50, 100]);
}

// Then update database
const { error } = await supabase
.from('teams')
.update({
buzzed_at: new Date().toISOString()
})
.eq('id', teamId);

if (error) {
console.error('Error buzzing in:', error);
// Revert on error
isBuzzed = false;
resetBuzzerToReady();
saveGameState();
return false;
}

return true;
}

function setBuzzerToBuzzedState() {
const buzzer = document.getElementById('buzzerBtn');
buzzer.className = 'w-11/12 aspect-square max-w-sm rounded-full text-center font-bold bg-gradient-to-b from-green-400 via-green-500 to-green-600 text-white relative shadow-2xl mb-3';
buzzer.innerHTML = `
<div class="flex flex-col items-center justify-center h-full relative z-10">
<div class="text-2xl mb-2 font-black">üî• YOU'RE IN! üî•</div>
<div class="text-4xl mb-2 animate-pulse">‚ö°</div>
<div class="text-lg leading-tight mb-1 font-bold">WAIT FOR HOST</div>
<div class="text-lg leading-tight font-bold">TO CALL ON YOU</div>
</div>
<div class="absolute inset-2 rounded-full bg-gradient-to-b from-green-300 to-green-400 opacity-30"></div>
<div class="absolute inset-4 rounded-full bg-gradient-to-b from-green-200 to-green-300 opacity-20"></div>
`;
}

function resetBuzzerToReady() {
const buzzer = document.getElementById('buzzerBtn');
buzzer.className = 'buzzer-glow w-11/12 aspect-square max-w-sm rounded-full text-center font-bold bg-gradient-to-b from-yellow-400 via-yellow-500 to-yellow-600 text-blue-900 relative shadow-2xl mb-3';
buzzer.innerHTML = `
<div class="flex flex-col items-center justify-center h-full relative z-10">
<div class="text-lg leading-tight mb-1 font-black">GET READY TO</div>
<div class="text-lg leading-tight mb-3 font-black">GET IN THE GAME!</div>
<div class="text-6xl mb-2">üö®</div>
<div class="text-2xl font-black">TAP TO BUZZ!</div>
</div>
<div class="absolute inset-2 rounded-full bg-gradient-to-b from-yellow-300 to-yellow-400 opacity-30"></div>
<div class="absolute inset-4 rounded-full bg-gradient-to-b from-yellow-200 to-yellow-300 opacity-20"></div>
`;
}

// Setup real-time subscriptions with enhanced error handling
function setupRealtime() {
if (realtimeChannel) {
supabase.removeChannel(realtimeChannel);
}

console.log('Setting up realtime for team:', teamId, 'game:', gameId);

realtimeChannel = supabase
.channel(`player_${teamId}_${Date.now()}`)
.on('postgres_changes',
{ event: 'UPDATE', schema: 'public', table: 'teams', filter: `id=eq.${teamId}` },
(payload) => {
console.log('Team update received:', payload);
const newData = payload.new;

// Handle buzzer clear
if (!newData.buzzed_at && isBuzzed) {
console.log('Buzzer cleared by host');
isBuzzed = false;
resetBuzzerToReady();
saveGameState();
}
}
)
.on('postgres_changes',
{ event: 'DELETE', schema: 'public', table: 'teams', filter: `id=eq.${teamId}` },
(payload) => {
console.log('Team deleted:', payload);
alert('You have been removed from the game by the host.');
exitGame();
}
)
.on('postgres_changes',
{ event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${gameId}` },
(payload) => {
console.log('Game update received:', payload);
const newData = payload.new;

// Handle score reveal
if (newData.status === 'scores_revealed' && newData.scores_data) {
console.log('Scores revealed! Data:', newData.scores_data);
try {
const placements = newData.scores_data; // No JSON.parse needed with jsonb
console.log('Parsed placements:', placements);
const myPlacement = placements[teamId];
console.log('My placement:', myPlacement, 'Team ID:', teamId);

if (myPlacement) {
showCelebration(myPlacement);
} else {
console.log('No placement found for team ID:', teamId);
}
} catch (e) {
console.error('Error parsing scores data:', e);
}
}

// Handle game end
if (newData.status === 'ended') {
alert('Game has ended by the host.');
exitGame();
}
}
)
.subscribe((status) => {
console.log('Realtime subscription status:', status);
});
}

function showCelebration(placement) {
console.log('Showing celebration for placement:', placement);
const { place, isTie } = placement;

let message;
if (isTie) {
message = `It's a Tie! You Got ${getOrdinal(place)} Place!`;
} else {
message = `You got ${getOrdinal(place)} place!`;
}

document.getElementById('placementMessage').textContent = `üéâ ${message} üéâ`;

// Play fanfare and create effects
playFanfareSound();
createFireworkConfetti();
createPartyEmojis();

// Show celebration screen
showScreen('celebration');

// Continue confetti loop
const confettiInterval = setInterval(() => {
createFireworkConfetti();
}, 3000);

// Clean up after a while
setTimeout(() => {
clearInterval(confettiInterval);
}, 30000);
}

function getOrdinal(num) {
const suffixes = ['th', 'st', 'nd', 'rd'];
const v = num % 100;
return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
}

function exitGame() {
// Cleanup
if (realtimeChannel) {
supabase.removeChannel(realtimeChannel);
}

clearGameState();
gameCode = '';
teamName = '';
teamId = null;
gameId = null;
isBuzzed = false;

// Reset forms
document.getElementById('gameCodeInput').value = '';
document.getElementById('teamNameInput').value = '';
document.getElementById('charCount').textContent = '0';

// Show buzzer and QR sections again (reset for dashboard)
document.getElementById('buzzerSection').style.display = 'flex';
document.getElementById('qrSection').style.display = 'block';

showScreen('entry');
}

// Game code validation
function isValidGameCodeFormat(code) {
return /^\d{6}$/.test(code);
}

// Event listeners
document.getElementById('gameCodeInput').addEventListener('input', function(e) {
let value = e.target.value.replace(/\D/g, '').slice(0, 6);
e.target.value = value;
gameCode = value;
});

document.getElementById('joinGameBtn').addEventListener('click', async function() {
if (gameCode.length === 6 && isValidGameCodeFormat(gameCode)) {
const validGameId = await validateGameCode(gameCode);
if (validGameId) {
showScreen('teamSetup');
} else {
alert('Invalid game code or game not active!');
}
} else if (gameCode.length > 0) {
alert('Please enter a valid 6-digit game code!');
} else {
alert('Please enter a game code!');
}
});

document.getElementById('teamNameInput').addEventListener('input', function(e) {
const value = e.target.value.slice(0, 40);
e.target.value = value;
teamName = value;
document.getElementById('charCount').textContent = value.length;
});

document.getElementById('submitTeamBtn').addEventListener('click', async function() {
if (teamName.trim().length >= 2) {
const success = await joinGame(gameCode, teamName.trim());
if (success) {
document.getElementById('teamNameDisplay').innerHTML = `‚≠ê ${teamName} ‚≠ê`;
document.getElementById('teamNameDisplay').style.color = '#5de1e6';
setupRealtime();
showScreen('dashboard');
}
} else {
alert('Please enter a team name with at least 2 characters!');
}
});

document.getElementById('buzzerBtn').addEventListener('click', async function() {
if (!isBuzzed) {
await buzzIn();
}
});

document.getElementById('cheerBtn').addEventListener('click', function() {
playClappingSound();
createPartyEmojis();
});

document.getElementById('exitGameBtn').addEventListener('click', function() {
if (confirm('Are you sure you want to leave the game?')) {
exitGame();
}
});

document.getElementById('exitCelebrationBtn').addEventListener('click', function() {
if (confirm('Are you sure you want to leave the game?')) {
exitGame();
}
});

// Keyboard support for accessibility
document.addEventListener('keydown', function(e) {
if (currentScreen === 'dashboard' && (e.key === ' ' || e.key === 'Enter')) {
e.preventDefault();
document.getElementById('buzzerBtn').click();
}
});

// Prevent zoom on double tap for mobile
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
const now = (new Date()).getTime();
if (now - lastTouchEnd <= 300) {
event.preventDefault();
}
lastTouchEnd = now;
}, false);

// Enhanced page visibility handling for better reconnection
document.addEventListener('visibilitychange', function() {
if (!document.hidden && teamId) {
// Page became visible again, check if we need to sync state
setTimeout(async () => {
try {
const { data: teamData } = await supabase
.from('teams')
.select('buzzed_at')
.eq('id', teamId)
.single();

if (teamData) {
const dbBuzzed = !!teamData.buzzed_at;
if (dbBuzzed !== isBuzzed) {
isBuzzed = dbBuzzed;
if (isBuzzed) {
setBuzzerToBuzzedState();
} else {
resetBuzzerToReady();
}
saveGameState();
}
}

// Also check game status
const { data: gameData } = await supabase
.from('games')
.select('status, scores_data')
.eq('id', gameId)
.single();

if (gameData && gameData.status === 'scores_revealed' && gameData.scores_data) {
try {
const placements = gameData.scores_data; // No JSON.parse needed with jsonb
const myPlacement = placements[teamId];
if (myPlacement && currentScreen !== 'celebration') {
showCelebration(myPlacement);
}
} catch (e) {
console.error('Error parsing scores data on visibility change:', e);
}
}
} catch (e) {
console.error('Error syncing state on visibility change:', e);
}
}, 500);
}
});

// Initialize app - try reconnection first
window.addEventListener('load', async function() {
console.log('App loading, attempting reconnection...');
const reconnected = await attemptReconnection();
if (!reconnected) {
console.log('No reconnection possible, showing entry screen');
showScreen('entry');
}
});
</script>
</body>
</html>
